- rules:
  - id: global-access-modifiers
    languages:
    - apex
    message: Global classes, methods, and variables should be avoided (especially
      in managed packages) as they can never be deleted or changed in signature. Always
      check twice if something needs to be global.
    metadata:
      category: best-practice
      cwe:
      - 'CWE-284: Improper Access Control'
      references:
      - https://cwe.mitre.org/data/definitions/284.html
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    patterns:
    - pattern-regex: global [A-Za-z0-9_]{3,}
    - pattern-not-regex: //(\s+([a-zA-Z]+\s+)+)[a-zA-Z]+
    - pattern-not-regex: '[*](\s+([a-zA-Z]+\s+)+)[a-zA-Z]+'
    severity: WARNING
- rules:
  - id: absolute-urls
    languages:
    - apex
    message: Using absolute URLs to Salesforce Pages is bug prone. Different sandboxes
      and production environments will have different instance names (like "na10",
      "na15" etc.). Code using absolute URLs will only work when it runs in the corresponding
      salesforce instances. It will break as soon as it is deployed in another one.
      Thus only relative URLs, i.e. without the domain and subdomain names, should
      be used when pointing to a salesforce page.
    metadata:
      category: best-practice
      references:
      - ''
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    pattern-regex: (http|https)://.*(salesforce|force|visualforce)\.com\.*
    severity: WARNING
- rules:
  - id: use-assert-class
    languages:
    - generic
    message: 'Assert methods in the System class have been replaced with the Assert
      class: https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_class_System_Assert.htm'
    metadata:
      category: best-practice
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_class_System_Assert.htm
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      include:
      - '*.cls'
      - UseAssertClass.cls
    pattern-regex: System\.assert
    severity: WARNING
- rules:
  - id: avoid-native-dml-in-loops
    languages:
    - generic
    message: Avoid DML statements inside loops to avoid hitting the DML governor limit.
      Instead, try to batch up the data into a list and invoke your DML once on that
      list of data outside the loop.
    metadata:
      category: performance
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-either:
      - pattern-inside: "for (...) {\n  ...\n}\n"
      - pattern-inside: "while (...) {\n  ...\n}\n"
      - pattern-inside: "do {\n  ...\n} while (...);\n"
    - pattern-either:
      - pattern: 'insert $DATA;

          '
      - pattern: 'update $DATA;

          '
      - pattern: 'upsert $DATA;

          '
      - pattern: 'delete $DATA;

          '
      - pattern: 'Database.insert($DATA);

          '
      - pattern: 'Database.update($DATA);

          '
      - pattern: 'Database.upsert($DATA);

          '
      - pattern: 'Database.delete($DATA);

          '
    severity: ERROR
- rules:
  - id: avoid-sosl-in-loops
    languages:
    - generic
    message: Database class methods, DML operations, SOQL queries, SOSL queries, Approval
      class methods, Email sending, async scheduling or queueing within loops can
      cause governor limit exceptions. Instead, try to batch up the data into a list
      and invoke the operation once on that list of data outside the loop.
    metadata:
      category: performance
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-either:
      - pattern-inside: "for (...) {\n  ...\n}\n"
      - pattern-inside: "while (...) {\n  ...\n}\n"
      - pattern-inside: "do {\n  ...\n} while (...);\n"
    - pattern-either:
      - pattern: '$OBJECTS = ... Search.query(...)

          '
      - pattern: '$OBJECTS = ... [FIND...IN ALL FIELDS RETURNING...]

          '
    severity: ERROR
- rules:
  - id: avoid-soql-in-loops
    languages:
    - generic
    message: Database class methods, DML operations, SOQL queries, SOSL queries, Approval
      class methods, Email sending, async scheduling or queueing within loops can
      cause governor limit exceptions. Instead, try to batch up the data into a list
      and invoke the operation once on that list of data outside the loop.
    metadata:
      category: performance
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-either:
      - pattern-inside: "for (...) {\n  ...\n}\n"
      - pattern-inside: "while (...) {\n  ...\n}\n"
      - pattern-inside: "do {\n  ...\n} while (...);\n"
    - pattern: '$OBJECTS = [...SELECT...FROM...];

        '
    severity: ERROR
- rules:
  - id: avoid-operations-with-limits-in-loops
    languages:
    - generic
    message: Database class methods, DML operations, SOQL queries, SOSL queries, Approval
      class methods, Email sending, async scheduling or queueing within loops can
      cause governor limit exceptions. Instead, try to batch up the data into a list
      and invoke the operation once on that list of data outside the loop.
    metadata:
      category: performance
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-either:
      - pattern-inside: "for (...) {\n  ...\n}\n"
      - pattern-inside: "while (...) {\n  ...\n}\n"
      - pattern-inside: "do {\n  ...\n} while (...);\n"
    - pattern-either:
      - pattern: 'Messaging.sendEmail(...);

          '
      - pattern: 'Approval.ProcessSubmitRequest $REQUEST = new Approval.ProcessSubmitRequest();

          '
      - pattern: 'System.enqueueJob(...);

          '
      - pattern: 'System.schedule(...);

          '
      - pattern: 'System.scheduleBatch(...);

          '
    severity: ERROR
- rules:
  - id: bad-crypto
    languages:
    - apex
    message: The rule makes sure you are using randomly generated IVs and keys for
      Crypto calls. Hard-coding these values greatly compromises the security of encrypted
      data.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-321: Use of Hard-coded Cryptographic Key'
      impact: HIGH
      likelihood: LOW
      owasp:
      - A02:2021 - Cryptographic Failures
      references:
      - https://cwe.mitre.org/data/definitions/321.html
      subcategory:
      - audit
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    pattern-either:
    - pattern: Blob $IV = Blob.valueOf('$STRING');...Crypto.encrypt($ONE, $TWO, $IV,
        $FOUR);
    - pattern: Blob $IV = Blob.valueOf('$STRING');...Crypto.decrypt($ONE, $TWO, $IV,
        $FOUR);
    - pattern: Blob $KEY = Blob.valueOf('$STRING');...Crypto.encrypt($ONE, $KEY, $THREE,
        $FOUR);
    - pattern: Blob $KEY = Blob.valueOf('$STRING');...Crypto.decrypt($ONE, $KEY, $THREE,
        $FOUR);
    severity: ERROR
- rules:
  - id: apex-csrf-constructor
    languages:
    - apex
    message: 'Having DML operations in Apex class constructor or initializers can
      have unexpected side effects: By just accessing a page, the DML statements would
      be executed and the database would be modified. Just querying the database is
      permitted.'
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-352: Cross-Site Request Forgery (CSRF)'
      cwe2020-top25': true
      cwe2021-top25': true
      cwe2022-top25': true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2021 - Broken Access Control
      references:
      - https://cwe.mitre.org/data/definitions/352.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    patterns:
    - pattern-either:
      - pattern-inside: public class $CLASSNAME {...}
      - pattern-inside: private class $CLASSNAME {...}
      - pattern-inside: public $SOME sharing class $CLASSNAME {...}
      - pattern-inside: private $SOME sharing class $CLASSNAME {...}
    - pattern-either:
      - pattern-inside: public $CLASSNAME() {...}
      - pattern-inside: private $CLASSNAME() {...}
    - pattern-either:
      - pattern: 'insert $DATA;

          '
      - pattern: 'update $DATA;

          '
      - pattern: 'upsert $DATA;

          '
      - pattern: 'delete $DATA;

          '
    severity: ERROR
- rules:
  - id: dml-native-statements
    languages:
    - apex
    message: Native Salesforce DML operations execute in system context, ignoring
      the current user's permissions, field-level security, organization-wide defaults,
      position in the role hierarchy, and sharing rules. Be mindful when using native
      Salesforce DML operations.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-863: Incorrect Authorization'
      impact: HIGH
      likelihood: LOW
      owasp:
      - A01:2021 - Broken Access Control
      - A04:2021 - Insecure Design
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_dml_section.htm
      - https://cwe.mitre.org/data/definitions/863.html
      - https://owasp.org/Top10/A04_2021-Insecure_Design/
      subcategory:
      - audit
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-either:
      - pattern-regex: (insert|upsert|update|delete)[\s]
      - pattern-regex: (insert|upsert|update|delete)[(]
    - pattern-not-regex: '[\/\/].*(insert|upsert|update|delete).*'
    - pattern-not-regex: '[\/\/].*(insert|upsert|update|delete)[\n]'
    - pattern-not-regex: .*[=].*(insert|upsert|update|delete).*[,;]
    severity: WARNING
- rules:
  - id: apex-csrf-static-constructor
    languages:
    - generic
    message: 'Having DML operations in Apex class constructor or initializers can
      have unexpected side effects: By just accessing a page, the DML statements would
      be executed and the database would be modified. Just querying the database is
      permitted.'
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-352: Cross-Site Request Forgery (CSRF)'
      cwe2020-top25': true
      cwe2021-top25': true
      cwe2022-top25': true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2021 - Broken Access Control
      references:
      - https://cwe.mitre.org/data/definitions/352.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    patterns:
    - pattern-inside: static {...}
    - pattern-either:
      - pattern: 'insert $DATA;

          '
      - pattern: 'update $DATA;

          '
      - pattern: 'upsert $DATA;

          '
      - pattern: 'delete $DATA;

          '
    severity: ERROR
- rules:
  - id: named-credentials-string-match
    languages:
    - apex
    message: Named Credentials (and callout endpoints) should be used instead of hard-coding
      credentials. 1. Hard-coded credentials are hard to maintain when mixed in with
      application code. 2. It is particularly hard to update hard-coded credentials
      when they are used amongst different classes. 3. Granting a developer access
      to the codebase means granting knowledge of credentials, and thus keeping a
      two-level access is not possible. 4. Using different credentials for different
      environments is troublesome and error-prone.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-540: Inclusion of Sensitive Information in Source Code'
      impact: HIGH
      likelihood: LOW
      references:
      - https://cwe.mitre.org/data/definitions/540.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    pattern: $REQUEST.setHeader('Authorization', $AUTHSTRING);
    severity: ERROR
- rules:
  - id: named-credentials-constant-match
    languages:
    - apex
    message: Named Credentials (and callout endpoints) should be used instead of hard-coding
      credentials. 1. Hard-coded credentials are hard to maintain when mixed in with
      application code. 2. It is particularly hard to update hard-coded credentials
      when they are used amongst different classes. 3. Granting a developer access
      to the codebase means granting knowledge of credentials, and thus keeping a
      two-level access is not possible. 4. Using different credentials for different
      environments is troublesome and error-prone.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-540: Inclusion of Sensitive Information in Source Code'
      impact: HIGH
      likelihood: LOW
      references:
      - https://cwe.mitre.org/data/definitions/540.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    mode: taint
    pattern-sinks:
    - patterns:
      - pattern: req.setHeader($X, ...);
      - focus-metavariable: $X
    pattern-sources:
    - pattern: '...String $X = ''Authorization'';'
    severity: ERROR
- rules:
  - id: insecure-http-request
    languages:
    - apex
    message: The software transmits sensitive or security-critical data in cleartext
      in a communication channel that can be sniffed by unauthorized actors.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-319: Cleartext Transmission of Sensitive Information'
      impact: MEDIUM
      likelihood: LOW
      references:
      - https://cwe.mitre.org/data/definitions/319.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    patterns:
    - pattern-regex: http[:][/][/]
    - pattern-not-regex: //.*
    - pattern-not-regex: '[*].*'
    severity: ERROR
- rules:
  - id: soql-injection-unescaped-url-param
    languages:
    - apex
    message: If a dynamic query must be used,leverage nFORCE Query Builder. In other
      programming languages, the related flaw is known as SQL injection. Apex doesn't
      use SQL, but uses its own database query language, SOQL. SOQL is much simpler
      and more limited in functionality than SQL. The risks are much lower for SOQL
      injection than for SQL injection, but the attacks are nearly identical to traditional
      SQL injection. SQL/SOQL injection takes user-supplied input and uses those values
      in a dynamic SOQL query. If the input isn't validated, it can include SOQL commands
      that effectively modify the SOQL statement and trick the application into performing
      unintended commands.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-943: Improper Neutralization of Special Elements in Data Query Logic'
      impact: HIGH
      likelihood: HIGH
      owasp:
      - A03:2021 - Injection
      references:
      - https://cwe.mitre.org/data/definitions/943.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    mode: taint
    pattern-sanitizers:
    - pattern: String.escapeSingleQuotes(...)
    pattern-sinks:
    - patterns:
      - pattern: Database.query($SINK,...);
      - focus-metavariable: $SINK
    pattern-sources:
    - by-side-effect: true
      pattern: ApexPage.getCurrentPage().getParameters.get($URLPARAM);
    severity: ERROR
- rules:
  - id: soql-injection-unescaped-param
    languages:
    - apex
    message: If a dynamic query must be used,leverage nFORCE Query Builder. In other
      programming languages, the related flaw is known as SQL injection. Apex doesn't
      use SQL, but uses its own database query language, SOQL. SOQL is much simpler
      and more limited in functionality than SQL. The risks are much lower for SOQL
      injection than for SQL injection, but the attacks are nearly identical to traditional
      SQL injection. SQL/SOQL injection takes user-supplied input and uses those values
      in a dynamic SOQL query. If the input isn't validated, it can include SOQL commands
      that effectively modify the SOQL statement and trick the application into performing
      unintended commands.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-943: Improper Neutralization of Special Elements in Data Query Logic'
      impact: HIGH
      likelihood: HIGH
      owasp:
      - A03:2021 - Injection
      references:
      - https://cwe.mitre.org/data/definitions/943.html
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    mode: taint
    pattern-sanitizers:
    - pattern-either:
      - pattern: String.escapeSingleQuotes($P)
      - pattern: Database.query(<... String.escapeSingleQuotes($P) ...>)
    pattern-sinks:
    - pattern: Database.query(<... $P ...>)
    pattern-sources:
    - by-side-effect: true
      patterns:
      - pattern: $M(...,String $P,...) { ... }
      - focus-metavariable: $P
    severity: ERROR
- rules:
  - id: system-debug
    languages:
    - apex
    message: In addition to debug statements potentially logging data excessively,
      debug statements also contribute to longer transactions and consume Apex CPU
      time even when debug logs are not being captured.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-489: Active Debug Code'
      - 'CWE-779: Logging of Excessive Data'
      impact: MEDIUM
      likelihood: LOW
      references:
      - https://cwe.mitre.org/data/definitions/489.html
      - https://cwe.mitre.org/data/definitions/779.html
      subcategory:
      - vuln
      technology:
      - vuln
    min-version: 1.44.0
    paths:
      exclude:
      - '*Test*'
      - '*test*'
    pattern: System.debug(...)
    severity: WARNING
- rules:
  - id: specify-sharing-level
    languages:
    - apex
    message: Every Apex class should have an explicit sharing mode declared. Use the
      `with sharing` or `without sharing` keywords on a class to specify whether sharing
      rules must be enforced. Use the `inherited sharing` keyword on an Apex class
      to run the class in the sharing mode of the class that called it.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-284: Improper Access Control'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A04:2021 - Insecure Design
      references:
      - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_classes_keywords_sharing.htm
      - https://cwe.mitre.org/data/definitions/284.html
      - https://owasp.org/Top10/A04_2021-Insecure_Design/
      subcategory:
      - vuln
      technology:
      - salesforce
    min-version: 1.44.0
    patterns:
    - pattern-regex: (private|public|global).*\s(class)\s.*[{]
    - pattern-not-regex: (private|public|global).*[with|without|inherited]\s[sharing].*\s(class)\s.*[{]
    - pattern-not-regex: (private|public|global).*\s(class)\s.*(extends)\s(Exception).*[{]
    severity: WARNING
