- rules:
  - id: broken-input-line
    languages:
    - ocaml
    message: '''input_line'' leaves a ''\r'' (CR) character when reading lines from
      a Windows text file, whose lines end in "\r\n" (CRLF). This is a problem for
      any Windows file that is being read either on a Unix-like platform or on Windows
      in binary mode. If the code already takes care of removing any trailing ''\r''
      after reading the line, add a ''(* nosemgrep *)'' comment to disable this warning.'
    metadata:
      category: portability
      technology:
      - ocaml
    pattern: 'input_line

      '
    severity: WARNING
  - fix: open_in_bin
    id: prefer-read-in-binary-mode
    languages:
    - ocaml
    message: '''open_in'' behaves differently on Windows and on Unix-like systems
      with respect to line endings. To get the same behavior everywhere, use ''open_in_bin''
      or ''open_in_gen [Open_binary]''. If you really want CRLF-to-LF translations
      to take place when running on Windows, use ''open_in_gen [Open_text]''.'
    metadata:
      category: portability
      technology:
      - ocaml
    pattern: open_in
    severity: WARNING
  - fix: open_out_bin
    id: prefer-write-in-binary-mode
    languages:
    - ocaml
    message: '''open_out'' behaves differently on Windows and on Unix-like systems
      with respect to line endings. To get the same behavior everywhere, use ''open_out_bin''
      or ''open_out_gen [Open_binary]''. If you really want LF-to-CRLF translations
      to take place when running on Windows, use ''open_out_gen [Open_text]''.'
    metadata:
      category: portability
      technology:
      - ocaml
    pattern: open_out
    severity: WARNING
- rules:
  - id: not-portable-tmp-string
    languages:
    - ocaml
    message: You should probably use Filename.get_temp_dirname().
    metadata:
      category: portability
      technology:
      - ocaml
    pattern: '"=~/\/tmp/"

      '
    severity: WARNING
- rules:
  - id: useless-let
    languages:
    - ocaml
    message: Useless let
    metadata:
      category: correctness
      technology:
      - ocaml
    pattern: let $X = $E in $X
    severity: ERROR
- rules:
  - id: useless-equal
    languages:
    - ocaml
    message: This is always true. If testing for floating point NaN, use `Float.is_nan`
      instead.
    metadata:
      category: correctness
      technology:
      - ocaml
    pattern: $X = $X
    severity: ERROR
- rules:
  - id: ocamllint-useless-if
    languages:
    - ocaml
    message: Useless if. Both branches are equal.
    metadata:
      category: correctness
      technology:
      - ocaml
    pattern: if $X then $E else $E
    severity: ERROR
- rules:
  - id: physical-equal
    languages:
    - ocaml
    message: You probably want the structural equality operator =
    metadata:
      category: correctness
      references:
      - https://v2.ocaml.org/api/Stdlib.html#1_Comparisons
      technology:
      - ocaml
    pattern: $X == $Y
    severity: WARNING
  - id: physical-not-equal
    languages:
    - ocaml
    message: You probably want the structural inequality operator <>
    metadata:
      category: correctness
      references:
      - https://v2.ocaml.org/api/Stdlib.html#1_Comparisons
      technology:
      - ocaml
    pattern: $X != $Y
    severity: WARNING
- rules:
  - id: useless-compare
    languages:
    - ocaml
    message: This comparison is useless because the expressions being compared are
      identical. This is expected to always return the same result, 0, unless your
      code is really strange.
    metadata:
      category: correctness
      technology:
      - ocaml
    patterns:
    - pattern-either:
      - pattern: compare $X $X
      - pattern: $MODULE.compare $X $X
    severity: ERROR
- rules:
  - id: deprecated-pervasives
    languages:
    - ocaml
    message: Pervasives is deprecated and will not be available after 4.10. Use Stdlib.
    metadata:
      category: compatibility
      technology:
      - ocaml
    pattern: Pervasives.$X
    severity: ERROR
- rules:
  - id: ocamllint-ref-incr
    languages:
    - ocaml
    message: You should use `incr`
    metadata:
      category: best-practice
      references:
      - https://v2.ocaml.org/api/Stdlib.html#VALincr
      - https://v2.ocaml.org/api/Atomic.html#VALincr
      technology:
      - ocaml
    pattern: $X := ! $X + 1
    severity: WARNING
  - id: ocamllint-ref-decr
    languages:
    - ocaml
    message: You should use `decr`
    metadata:
      category: best-practice
      references:
      - https://v2.ocaml.org/api/Stdlib.html#VALdecr
      - https://v2.ocaml.org/api/Atomic.html#VALdecr
      technology:
      - ocaml
    pattern: $X := ! $X - 1
    severity: WARNING
- rules:
  - id: ocamllint-useless-else
    languages:
    - ocaml
    message: Useless else. Just remove the else branch;
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern: if $E then $E1 else ()
    severity: WARNING
  - id: ocamllint-backwards-if
    languages:
    - ocaml
    message: Backwards if. Rewrite the code as 'if not $E then $E2'.
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern: if $E then () else $E2
    severity: WARNING
- rules:
  - id: bad-reraise
    languages:
    - ocaml
    message: You should not re-raise exceptions using 'raise' because it loses track
      of where the exception was raised originally, leading to a useless and possibly
      confusing stack trace. Instead, you should obtain a stack backtrace as soon
      as the exception is caught using 'try ... with exn -> let trace = Printexc.get_raw_backtrace
      () in ...', and keep it around until you re-raise the exception using 'Printexc.raise_with_backtrace
      exn trace'. You must collect the stack backtrace before calling another function
      which might internally raise and catch exceptions. To avoid false positives
      from Semgrep, write 'raise (Foo args)' instead of 'let e = Foo args in raise
      e'.
    metadata:
      category: best-practice
      references:
      - https://v2.ocaml.org/api/Printexc.html
      technology:
      - ocaml
    patterns:
    - pattern: 'raise $EXN

        '
    - metavariable-regex:
        metavariable: $EXN
        regex: \A[a-z_][a-z_A-Z0-9']*\z
    severity: WARNING
- rules:
  - id: hashtbl-find-outside-try
    languages:
    - ocaml
    message: You should not use Hashtbl.find outside of a try, or you should use Hashtbl.find_opt
    metadata:
      category: best-practice
      technology:
      - ocaml
    patterns:
    - pattern: 'Hashtbl.find ...

        '
    - pattern-not-inside: 'try ... with ... -> ...

        '
    - pattern-not-inside: 'match ... with | ... -> ...

        '
    severity: WARNING
- rules:
  - id: list-find-outside-try
    languages:
    - ocaml
    message: You should not use List.find outside of a try, or you should use List.find_opt
    metadata:
      category: best-practice
      technology:
      - ocaml
    patterns:
    - pattern: 'List.find ...

        '
    - pattern-not-inside: 'try ... with ... -> ...

        '
    severity: WARNING
- rules:
  - id: ocamllint-str-first-chars
    languages:
    - ocaml
    message: Use instead `Str.first_chars`
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern: String.sub $S 0 $N
    severity: WARNING
  - id: ocamllint-str-string-after
    languages:
    - ocaml
    message: Use instead `Str.string_after`
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern: String.sub $S $N (String.length $S - $N)
    severity: WARNING
  - id: ocamllint-str-last-chars
    languages:
    - ocaml
    message: Use instead `Str.last_chars`
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern: String.sub $S (String.length $S - $N) $N
    severity: WARNING
  - id: ocamllint-useless-sprintf
    languages:
    - ocaml
    message: Useless sprintf
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern-either:
    - pattern: Printf.sprintf "..."
    - pattern: Printf.sprintf "%s" $S
    severity: WARNING
- rules:
  - id: ocamllint-bool-true
    languages:
    - ocaml
    message: Comparison to boolean. Just use `$X`
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern-either:
    - pattern: $X = true
    - pattern: $X == true
    - pattern: $X != false
    severity: WARNING
  - id: ocamllint-bool-false
    languages:
    - ocaml
    message: Comparison to boolean. Just use `not $X`
    metadata:
      category: best-practice
      technology:
      - ocaml
    pattern-either:
    - pattern: $X = false
    - pattern: $X == false
    - pattern: $X <> true
    severity: WARNING
- rules:
  - id: ocamllint-length-list-zero
    languages:
    - ocaml
    message: You probably want $X = [], which is faster.
    metadata:
      category: performance
      technology:
      - ocaml
    pattern: List.length $X = 0
    severity: WARNING
  - id: ocamllint-length-more-than-zero
    languages:
    - ocaml
    message: You probably want $X <> [], which is faster.
    metadata:
      category: performance
      technology:
      - ocaml
    pattern: List.length $X > 0
    severity: WARNING
- rules:
  - id: ocamllint-unsafe
    languages:
    - ocaml
    message: Unsafe functions do not perform boundary checks or have other side effects,
      use with care.
    metadata:
      category: security
      confidence: MEDIUM
      cwe: 'CWE-242: Use of Inherently Dangerous Function (4.12)'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://v2.ocaml.org/api/Bigarray.Array1.html#VALunsafe_get
      - https://v2.ocaml.org/api/Bytes.html#VALunsafe_to_string
      subcategory:
      - audit
      technology:
      - ocaml
    pattern-either:
    - pattern: $X.unsafe_get
    - pattern: $X.unsafe_set
    - pattern: $X.unsafe_to_string
    - pattern: $X.unsafe_of_string
    - pattern: $X.unsafe_blit
    - pattern: $X.unsafe_blit_string
    - pattern: $X.unsafe_fill
    - pattern: $X.unsafe_to_string
    - pattern: $X.unsafe_getenv
    - pattern: $X.unsafe_environment
    - pattern: $X.unsafe_chr
    - pattern: $X.unsafe_of_int
    - pattern: $X.unsafe_output
    - pattern: $X.unsafe_output_string
    - pattern: $X.unsafe_read
    - pattern: $X.unsafe_recv
    - pattern: $X.unsafe_recvfrom
    - pattern: $X.unsafe_send
    - pattern: $X.unsafe_sendto
    - pattern: $X.unsafe_set
    - pattern: $X.unsafe_set_int16
    - pattern: $X.unsafe_set_int32
    - pattern: $X.unsafe_set_int64
    - pattern: $X.unsafe_set_int8
    - pattern: $X.unsafe_set_uint16_ne
    - pattern: $X.unsafe_set_uint8
    - pattern: $X.unsafe_single_write
    - pattern: $X.unsafe_string
    - pattern: $X.unsafe_sub
    - pattern: $X.unsafe_write
    severity: WARNING
- rules:
  - id: ocamllint-tempfile
    languages:
    - ocaml
    message: Filename.temp_file might lead to race conditions, since the file could
      be altered or replaced by a symlink before being opened.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://v2.ocaml.org/api/Filename.html
      subcategory:
      - audit
      technology:
      - ocaml
    pattern: Filename.temp_file
    severity: WARNING
- rules:
  - id: ocamllint-hashtable-dos
    languages:
    - ocaml
    message: Creating a Hashtbl without the optional random number parameter makes
      it prone to DoS attacks when attackers are able to fill the table with malicious
      content. Hashtbl.randomize or the R flag in the OCAMLRUNPARAM are other ways
      to randomize it.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-399: Resource Management Errors (4.12)'
      impact: LOW
      likelihood: LOW
      references:
      - https://v2.ocaml.org/api/Hashtbl.html
      subcategory:
      - audit
      technology:
      - ocaml
    patterns:
    - pattern: Hashtbl.create $Y
    - pattern-not: Hashtbl.create $Y ~random:true
    severity: WARNING
- rules:
  - id: ocamllint-digest
    languages:
    - ocaml
    message: Digest uses MD5 and should not be used for security purposes. Consider
      using SHA256 instead.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-328: Use of Weak Hash (4.12)'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://v2.ocaml.org/api/Digest.html
      subcategory:
      - audit
      technology:
      - ocaml
    pattern-either:
    - pattern: Digest.string
    - pattern: Digest.bytes
    - pattern: Digest.substring
    - pattern: Digest.subbytes
    - pattern: Digest.channel
    - pattern: Digest.file
    severity: WARNING
- rules:
  - id: ocamllint-filenameconcat
    languages:
    - ocaml
    message: When attacker supplied data is passed to Filename.concat directory traversal
      attacks might be possible.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-35: Path Traversal'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://v2.ocaml.org/api/Filename.html
      subcategory:
      - audit
      technology:
      - ocaml
    pattern: Filename.concat
    severity: WARNING
- rules:
  - id: ocamllint-exec
    languages:
    - ocaml
    message: Executing external programs might lead to comand or argument injection
      vulnerabilities.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-78: OS Command Injection'
      impact: HIGH
      likelihood: MEDIUM
      references:
      - https://v2.ocaml.org/api/Unix.html
      subcategory:
      - audit
      technology:
      - ocaml
    patterns:
    - pattern-either:
      - pattern: Unix.execve $STR
      - pattern: Unix.execvp $STR
      - pattern: Unix.execvpe $STR
      - pattern: Unix.system $STR
      - pattern: Sys.command $STR
    - pattern-not: Unix.execve "..."
    - pattern-not: Unix.execvp "..."
    - pattern-not: Unix.execvpe "..."
    - pattern-not: Unix.system "..."
    - pattern-not: Sys.command "..."
    severity: WARNING
- rules:
  - id: ocamllint-marshal
    languages:
    - ocaml
    message: Marshaling is currently not type-safe and can lead to insecure behaviour
      when untrusted data is marshalled. Marshalling can lead to out-of-bound reads
      as well.
    metadata:
      category: security
      confidence: LOW
      cwe: 'CWE-502: Deserialization of Untrusted Data'
      impact: HIGH
      likelihood: MEDIUM
      references:
      - https://eternal.red/2021/secure-ocaml-sandbox/
      subcategory:
      - vuln
      technology:
      - ocaml
    pattern-either:
    - pattern: input_value
    - pattern: Marshal.from_channel
    - pattern: Marshal.from_bytes
    - pattern: Marshal.from_string
    severity: WARNING
