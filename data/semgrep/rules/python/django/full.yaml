- rules:
  - id: nontext-field-must-set-null-true
    languages:
    - python
    message: null=True should be set if blank=True is set on non-text fields.
    metadata:
      category: correctness
      references:
      - https://docs.djangoproject.com/en/4.0/ref/models/fields/#null
      technology:
      - django
    patterns:
    - pattern-inside: "class $M(...):\n  ...\n"
    - pattern-not: $F = django.db.models.CharField(...)
    - pattern-not: $F = django.db.models.TextField(...)
    - pattern-not: $F = django.db.models.SlugField(...)
    - pattern-not: $F = django.db.models.EmailField(...)
    - pattern-not: $F = django.db.models.FileField(...)
    - pattern-not: $F = django.db.models.ImageField(...)
    - pattern-not: $F = django.db.models.URLField(...)
    - pattern-not: $F = django.db.models.UUIDField(...)
    - pattern-not: $F = django.db.models.ManyToManyField(...)
    - pattern-not: $F = django.db.models.NullBooleanField(...)
    - pattern-not: $F = django.contrib.gis.db.models.$MODEL(...)
    - pattern-not: $F = phonenumber_field.modelfields.PhoneNumberField(...)
    - pattern-not: $F = ckeditor.fields.RichTextField(...)
    - pattern-not: $F = $X(..., null=True, blank=True, ...)
    - pattern: $F = $X(..., blank=True, ...)
    severity: ERROR
- rules:
  - id: use-decimalfield-for-money
    languages:
    - python
    message: Found a FloatField used for variable $F. Use DecimalField for currency
      fields to avoid float-rounding errors.
    metadata:
      category: correctness
      technology:
      - django
    patterns:
    - pattern-inside: "class $M(...):\n  ...\n"
    - pattern: $F = django.db.models.FloatField(...)
    - metavariable-regex:
        metavariable: $F
        regex: .*([pP][rR][iI][cC][eE]|[aA][mM][oO][uU][nN][tT]|[sS][uU][bB][tT][oO][tT][aA][lL]|[dD][oO][nN][aA][tT][iI][oO][nN]|[fF][eE][eE]|[sS][aA][lL][aA][rR][yY]|[pP][rR][eE][cC][iI][oO]).*
    severity: ERROR
- rules:
  - id: django-db-model-save-super
    languages:
    - python
    message: Detected a django model `$MODEL` is not calling super().save() inside
      of the save method.
    metadata:
      category: correctness
      technology:
      - django
    patterns:
    - pattern-inside: "class $MODEL(django.db.models.Model):\n    ...\n"
    - pattern-not: "def save(self, ...):\n  ...\n  super($MODEL, self).save(...)\n"
    - pattern-not: "def save(self, ...):\n  ...\n  super().save(...)\n"
    - pattern: "def save(self, ...):\n  ...\n"
    severity: WARNING
- rules:
  - id: no-null-string-field
    languages:
    - python
    message: 'Avoid using null on string-based fields such as CharField and TextField.
      If a string-based field has null=True, that means it has two possible values
      for "no data": NULL, and the empty string. In most cases, it''s redundant to
      have two possible values for "no data;" the Django convention is to use the
      empty string, not NULL.'
    metadata:
      category: correctness
      technology:
      - django
    patterns:
    - pattern-inside: "class $M(...):\n  ...\n"
    - pattern-not: $F = django.db.models.CharField(..., null=True, unique=True, blank=True,
        ...)
    - pattern-not: $F = django.db.models.TextField(..., null=True, unique=True, blank=True,
        ...)
    - pattern-either:
      - pattern: $F = django.db.models.CharField(..., null=True, ...)
      - pattern: $F = django.db.models.TextField(..., null=True, ...)
    severity: WARNING
  - id: string-field-must-set-null-true
    languages:
    - python
    message: If a text field declares unique=True and blank=True, null=True must also
      be set to avoid unique constraint violations when saving multiple objects with
      blank values.
    metadata:
      category: correctness
      technology:
      - django
    patterns:
    - pattern-inside: "class $M(...):\n  ...\n"
    - pattern-not: $F = django.db.models.CharField(..., unique=True, blank=True, null=True,
        ...)
    - pattern-not: $F = django.db.models.TextField(..., unique=True, blank=True, null=True,
        ...)
    - pattern-either:
      - pattern: $F = django.db.models.CharField(..., unique=True, blank=True, ...)
      - pattern: $F = django.db.models.TextField(..., unique=True, blank=True, ...)
    severity: ERROR
- rules:
  - id: django-compat-2_0-signals-weak
    languages:
    - python
    message: The weak argument to django.dispatch.signals.Signal.disconnect() is removed
      in Django 2.0.
    metadata:
      category: compatibility
      technology:
      - django
    pattern: django.dispatch.signals.Signal.disconnect(..., weak=$X, ...)
    severity: WARNING
  - id: django-compat-2_0-check-aggregate-support
    languages:
    - python
    message: django.db.backends.base.BaseDatabaseOperations.check_aggregate_support()
      is removed in Django 2.0.
    metadata:
      category: compatibility
      technology:
      - django
    pattern: django.db.backends.base.BaseDatabaseOperations.check_aggregate_support(...)
    severity: WARNING
  - id: django-compat-2_0-extra-forms
    languages:
    - python
    message: The django.forms.extras package is removed in Django 2.0.
    metadata:
      category: compatibility
      technology:
      - django
    pattern-either:
    - pattern: from django.forms import extras
    - pattern: from django.forms.extras import $X
    - pattern: from django.forms import extras as $Y
    - pattern: from django.forms.extras import $X as $Y
    - pattern: import django.forms.extras
    - pattern: import django.forms.extras.$X
    - pattern: import django.forms.extras as $Y
    - pattern: import django.forms.extras.$X as $Y
    severity: WARNING
  - id: django-compat-2_0-assignment-tag
    languages:
    - python
    message: The assignment_tag helper is removed in Django 2.0.
    metadata:
      category: compatibility
      technology:
      - django
    pattern-either:
    - pattern: $X.assignment_tag(...)
    - pattern: assignment_tag(...)
    severity: WARNING
  - id: django-compat-2_0-assert-redirects-helper
    languages:
    - python
    message: The host argument to assertRedirects is removed in Django 2.0.
    metadata:
      category: compatibility
      technology:
      - django
    pattern-either:
    - pattern: $X.assertRedirects(..., host=$Y, ...)
    - pattern: assertRedirects(..., host=$Y, ...)
    severity: WARNING
- rules:
  - id: duplicate-path-assignment
    languages:
    - python
    message: path for `$URL` is uselessly assigned twice
    metadata:
      category: maintainability
      references:
      - https://docs.djangoproject.com/en/3.2/topics/http/urls/#naming-url-patterns
      technology:
      - django
    patterns:
    - pattern: '[..., django.urls.path(''$URL'', $VIEW, ...), ..., django.urls.path(''$URL'',
        $VIEW, ...), ...]

        '
    severity: WARNING
  - id: conflicting-path-assignment
    languages:
    - python
    message: The path for `$URL` is assigned once to view `$VIEW` and once to `$DIFFERENT_VIEW`,
      which can lead to unexpected behavior. Verify what the intended target view
      is and delete the other route.
    metadata:
      category: maintainability
      references:
      - https://docs.djangoproject.com/en/3.2/topics/http/urls/#naming-url-patterns
      technology:
      - django
    patterns:
    - pattern: '[..., django.urls.path(''$URL'', $VIEW, ...), ..., django.urls.path(''$URL'',
        $DIFFERENT_VIEW, ...), ...]

        '
    - pattern-not: '[..., django.urls.path(''$URL'', $VIEW, ...), ..., django.urls.path(''$URL'',
        $VIEW, ...), ...]

        '
    severity: ERROR
  - id: duplicate-path-assignment-different-names
    languages:
    - python
    message: path for `$URL` is assigned twice with different names
    metadata:
      category: maintainability
      references:
      - https://docs.djangoproject.com/en/3.2/topics/http/urls/#naming-url-patterns
      technology:
      - django
    patterns:
    - pattern: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...), ...,
        django.urls.path(''$URL'', $VIEW, name=''$OTHER_NAME'', ...), ...]

        '
    - pattern-not: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...),
        ..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...), ...]

        '
    severity: WARNING
  - id: duplicate-name-assignment
    languages:
    - python
    message: The name `$NAME` is used for both `$URL` and `$OTHER_URL`, which can
      lead to unexpected behavior when using URL reversing. Pick a unique name for
      each path.
    metadata:
      category: maintainability
      references:
      - https://docs.djangoproject.com/en/3.2/topics/http/urls/#naming-url-patterns
      technology:
      - django
    patterns:
    - pattern: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...), ...,
        django.urls.path(''$OTHER_URL'', $OTHER_VIEW, name=''$NAME'', ...), ...]

        '
    - pattern-not: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...),
        ..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...), ...]

        '
    - pattern-not: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...),
        ..., django.urls.path(''$URL'', $OTHER_VIEW, name=''$NAME'', ...), ...]

        '
    - pattern-not: '[..., django.urls.path(''$URL'', $VIEW, name=''$NAME'', ...),
        ..., django.urls.path(''$OTHER_URL'', $VIEW, name=''$NAME'', ...), ...]

        '
    severity: ERROR
- rules:
  - id: use-django-environ
    languages:
    - python
    message: You are using environment variables inside django app. Use `django-environ`
      as it a better alternative for deployment.
    metadata:
      category: best-practice
      technology:
      - django
    patterns:
    - pattern-not-inside: 'import environ

        ...

        '
    - pattern-either:
      - pattern: 'import django

          ...

          import os

          ...

          $FOO = $M.environ[...]

          '
      - pattern: 'import os

          ...

          import django

          ...

          $FOO = $M.environ[...]

          '
    severity: ERROR
- rules:
  - id: use-json-response
    languages:
    - python
    message: Use JsonResponse instead
    metadata:
      category: best-practice
      technology:
      - django
    patterns:
    - pattern-inside: "def $X(...):\n  ...\n"
    - pattern: '$Y = json.dumps(...)

        ...

        django.http.HttpResponse($Y, ...)

        '
    severity: ERROR
- rules:
  - id: use-onetoonefield
    languages:
    - python
    message: Use 'django.db.models.OneToOneField' instead of 'ForeignKey' with unique=True.
      'OneToOneField' is used to create one-to-one relationships.
    metadata:
      category: best-practice
      technology:
      - django
    patterns:
    - pattern-inside: "class $M(...):\n  ...\n"
    - pattern: $F = django.db.models.ForeignKey(..., unique=True, ...)
    severity: WARNING
- rules:
  - id: access-foreign-keys
    languages:
    - python
    message: You should use ITEM.user_id rather than ITEM.user.id to prevent running
      an extra query.
    metadata:
      category: performance
      references:
      - https://docs.djangoproject.com/en/5.0/topics/db/optimization/#use-foreign-key-values-directly
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern-inside: 'from django.$Y import $Z

          ...

          '
      - pattern-inside: 'import django

          ...

          '
    - pattern: $X.user.id
    - pattern-not: request.user.id
    - pattern-not: self.request.user.id
    severity: WARNING
- rules:
  - id: use-count-method
    languages:
    - python
    message: Looks like you need to determine the number of records. Django provides
      the count() method which is more efficient than .len(). See https://docs.djangoproject.com/en/3.0/ref/models/querysets/
    metadata:
      category: performance
      technology:
      - django
    pattern-either:
    - pattern: $X.objects.$FUNC(...).len()
    - pattern: $X.objects.$FUNC(...).$FILTER().len()
    - pattern: $X.objects.$FUNC(...).$FILTER().$UPDATE(...).len()
    severity: ERROR
- rules:
  - id: use-earliest-or-latest
    languages:
    - python
    message: Looks like you are only accessing first element of an ordered QuerySet.
      Use `latest()` or `earliest()` instead. See https://docs.djangoproject.com/en/3.0/ref/models/querysets/#django.db.models.query.QuerySet.latest
    metadata:
      category: performance
      technology:
      - django
    pattern-either:
    - pattern: $X.objects.order_by(...)[0]
    - pattern: $X.objects.$FUNC(...).order_by(...)[0]
    - pattern: $X.objects.$FUNC(...).$FILTER(...).order_by(...)[0]
    severity: ERROR
- rules:
  - id: hashids-with-django-secret
    languages:
    - python
    message: The Django secret key is used as salt in HashIDs. The HashID mechanism
      is not secure. By observing sufficient HashIDs, the salt used to construct them
      can be recovered. This means the Django secret key can be obtained by attackers,
      through the HashIDs.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-327: Use of a Broken or Risky Cryptographic Algorithm'
      impact: HIGH
      likelihood: LOW
      owasp:
      - "A02:2021 \u2013 Cryptographic Failures"
      references:
      - https://docs.djangoproject.com/en/4.2/ref/settings/#std-setting-SECRET_KEY
      - http://carnage.github.io/2015/08/cryptanalysis-of-hashids
      subcategory:
      - vuln
      technology:
      - django
    pattern-either:
    - pattern: hashids.Hashids(..., salt=django.conf.settings.SECRET_KEY, ...)
    - pattern: hashids.Hashids(django.conf.settings.SECRET_KEY, ...)
    severity: ERROR
- rules:
  - id: globals-as-template-context
    languages:
    - python
    message: 'Using ''globals()'' as a context to ''render(...)'' is extremely dangerous.
      This exposes Python functions to the template that were not meant to be exposed.
      An attacker could use these functions to execute code that was not intended
      to run and could compromise the application. (This is server-side template injection
      (SSTI)). Do not use ''globals()''. Instead, specify each variable in a dictionary
      or ''django.template.Context'' object, like ''{"var1": "hello"}'' and use that
      instead.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-96: Improper Neutralization of Directives in Statically Saved Code (''Static
        Code Injection'')'
      impact: HIGH
      likelihood: LOW
      owasp:
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.2/ref/settings/#templates
      - https://docs.djangoproject.com/en/3.2/topics/templates/#django.template.backends.django.DjangoTemplates
      - https://docs.djangoproject.com/en/3.2/ref/templates/api/#rendering-a-context
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: django.shortcuts.render(..., globals(...), ...)
    - pattern: django.template.Template.render(..., globals(...), ...)
    - patterns:
      - pattern-inside: '$CONTEXT = globals(...)

          ...

          '
      - pattern-either:
        - pattern: django.shortcuts.render(..., $CONTEXT, ...)
        - pattern: django.template.Template.render(..., $CONTEXT, ...)
    severity: ERROR
- rules:
  - id: django-no-csrf-token
    languages:
    - generic
    message: Manually-created forms in django templates should specify a csrf_token
      to prevent CSRF attacks.
    metadata:
      category: security
      confidence: MEDIUM
      cwe: 'CWE-352: Cross-Site Request Forgery (CSRF)'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://docs.djangoproject.com/en/4.2/howto/csrf/
      subcategory:
      - audit
      technology:
      - django
    paths:
      include:
      - '*.html'
    patterns:
    - pattern: <form...>...</form>
    - pattern-either:
      - pattern: '<form ... method="$METHOD" ...>...</form>

          '
      - pattern: '<form ... method=''$METHOD'' ...>...</form>

          '
      - pattern: '<form ... method=$METHOD ...>...</form>

          '
    - metavariable-regex:
        metavariable: $METHOD
        regex: (?i)(post|put|delete|patch)
    - pattern-not-inside: <form...>...{% csrf_token %}...</form>
    - pattern-not-inside: <form...>...{{ $VAR.csrf_token }}...</form>
    severity: WARNING
- rules:
  - id: django-using-request-post-after-is-valid
    languages:
    - python
    message: Use $FORM.cleaned_data[] instead of request.POST[] after form.is_valid()
      has been executed to only access sanitized data
    metadata:
      category: security
      confidence: MEDIUM
      cwe: 'CWE-20: Improper Input Validation'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://docs.djangoproject.com/en/4.2/ref/forms/api/#accessing-clean-data
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(request, ...):\n  ...\n"
    - pattern-inside: "if $FORM.is_valid():\n  ...\n"
    - pattern-either:
      - pattern: request.POST[...]
      - pattern: request.POST.get(...)
    severity: WARNING
- rules:
  - id: locals-as-template-context
    languages:
    - python
    message: 'Using ''locals()'' as a context to ''render(...)'' is extremely dangerous.
      This exposes Python functions to the template that were not meant to be exposed.
      An attacker could use these functions to execute code that was not intended
      to run and could compromise the application. (This is server-side template injection
      (SSTI)). Do not use ''locals()''. Instead, specify each variable in a dictionary
      or ''django.template.Context'' object, like ''{"var1": "hello"}'' and use that
      instead.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-96: Improper Neutralization of Directives in Statically Saved Code (''Static
        Code Injection'')'
      impact: HIGH
      likelihood: LOW
      owasp:
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.2/ref/settings/#templates
      - https://docs.djangoproject.com/en/3.2/topics/templates/#django.template.backends.django.DjangoTemplates
      - https://docs.djangoproject.com/en/3.2/ref/templates/api/#rendering-a-context
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: django.shortcuts.render(..., locals(...), ...)
    - pattern: django.template.Template.render(..., locals(...), ...)
    - patterns:
      - pattern-inside: '$CONTEXT = locals(...)

          ...

          '
      - pattern-either:
        - pattern: django.shortcuts.render(..., $CONTEXT, ...)
        - pattern: django.template.Template.render(..., $CONTEXT, ...)
    severity: ERROR
- rules:
  - id: nan-injection
    languages:
    - python
    message: Found user input going directly into typecast for bool(), float(), or
      complex(). This allows an attacker to inject Python's not-a-number (NaN) into
      the typecast. This results in undefind behavior, particularly when doing comparisons.
      Either cast to a different type, or add a guard checking for all capitalizations
      of the string 'nan'.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-704: Incorrect Type Conversion or Cast'
      impact: MEDIUM
      likelihood: MEDIUM
      references:
      - https://discuss.python.org/t/nan-breaks-min-max-and-sorting-functions-a-solution/2868
      - https://blog.bitdiscovery.com/2021/12/python-nan-injection/
      subcategory:
      - vuln
      technology:
      - django
    mode: taint
    pattern-sanitizers:
    - not_conflicting: true
      pattern: $ANYTHING(...)
    pattern-sinks:
    - patterns:
      - pattern-either:
        - pattern: float(...)
        - pattern: bool(...)
        - pattern: complex(...)
      - pattern-not-inside: "if $COND:\n  ...\n...\n"
    pattern-sources:
    - patterns:
      - pattern-inside: "def $FUNC(request, ...):\n  ...\n"
      - pattern-either:
        - pattern: request.$PROPERTY.get(...)
        - pattern: request.$PROPERTY[...]
    severity: ERROR
- rules:
  - id: tainted-url-host
    languages:
    - python
    message: User data flows into the host portion of this manually-constructed URL.
      This could allow an attacker to send data to their own server, potentially exposing
      sensitive data such as cookies or authorization information sent with this request.
      They could also probe internal servers or other resources that the server running
      this code can access. (This is called server-side request forgery, or SSRF.)
      Do not allow arbitrary hosts. Instead, create an allowlist for approved hosts,
      or hardcode the correct host.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-918: Server-Side Request Forgery (SSRF)'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A10:2021 - Server-Side Request Forgery (SSRF)
      references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html
      subcategory:
      - audit
      technology:
      - flask
    mode: taint
    pattern-sinks:
    - patterns:
      - pattern-either:
        - patterns:
          - pattern: '"$URLSTR" % ...'
          - metavariable-pattern:
              language: generic
              metavariable: $URLSTR
              patterns:
              - pattern-either:
                - pattern: $SCHEME://%s
                - pattern: $SCHEME://%r
        - patterns:
          - pattern: '"$URLSTR".format(...)'
          - metavariable-pattern:
              language: generic
              metavariable: $URLSTR
              pattern: $SCHEME:// { ... }
        - patterns:
          - pattern: '"$URLSTR" + ...'
          - metavariable-regex:
              metavariable: $URLSTR
              regex: .*://$
        - patterns:
          - pattern: f"$URLSTR{...}..."
          - metavariable-regex:
              metavariable: $URLSTR
              regex: .*://$
        - patterns:
          - pattern-inside: '$URL = "$URLSTR"

              ...

              '
          - pattern: $URL += ...
          - metavariable-regex:
              metavariable: $URLSTR
              regex: .*://$
    pattern-sources:
    - patterns:
      - pattern: request.$ANYTHING
      - pattern-not: request.build_absolute_uri
    severity: WARNING
- rules:
  - id: tainted-sql-string
    languages:
    - python
    message: Detected user input used to manually construct a SQL string. This is
      usually bad practice because manual construction could accidentally result in
      a SQL injection. An attacker could use a SQL injection to steal or modify contents
      of the database. Instead, use a parameterized query which is available by default
      in most database engines. Alternatively, consider using the Django object-relational
      mappers (ORM) instead of raw SQL queries.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-915: Improperly Controlled Modification of Dynamically-Determined Object
        Attributes'
      impact: LOW
      likelihood: MEDIUM
      owasp:
      - A08:2021 - Software and Data Integrity Failures
      references:
      - https://docs.djangoproject.com/en/3.0/topics/security/#sql-injection-protection
      subcategory:
      - audit
      technology:
      - django
    mode: taint
    pattern-sinks:
    - patterns:
      - pattern-either:
        - pattern: '"$SQLSTR" + ...

            '
        - pattern: '"$SQLSTR" % ...

            '
        - pattern: '"$SQLSTR".format(...)

            '
        - pattern: 'f"$SQLSTR{...}..."

            '
      - metavariable-regex:
          metavariable: $SQLSTR
          regex: \s*(?i)(select|delete|insert|create|update|alter|drop)\b.*
    pattern-sources:
    - patterns:
      - pattern: request.$ANYTHING
      - pattern-not: request.build_absolute_uri
    severity: ERROR
- rules:
  - id: raw-html-format
    languages:
    - python
    message: Detected user input flowing into a manually constructed HTML string.
      You may be accidentally bypassing secure methods of rendering HTML by manually
      constructing HTML and this could create a cross-site scripting vulnerability,
      which could let attackers steal sensitive user data. To be sure this is safe,
      check that the HTML is rendered safely. Otherwise, use templates (`django.shortcuts.render`)
      which will safely render HTML instead.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: HIGH
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.2/topics/http/shortcuts/#render
      - https://docs.djangoproject.com/en/3.2/topics/security/#cross-site-scripting-xss-protection
      subcategory:
      - vuln
      technology:
      - django
    mode: taint
    pattern-sanitizers:
    - pattern: django.utils.html.escape(...)
    pattern-sinks:
    - patterns:
      - pattern-either:
        - patterns:
          - pattern-either:
            - pattern: '"$HTMLSTR" % ...'
            - pattern: '"$HTMLSTR".format(...)'
            - pattern: '"$HTMLSTR" + ...'
            - pattern: f"$HTMLSTR{...}..."
        - patterns:
          - pattern-inside: '$HTML = "$HTMLSTR"

              ...

              '
          - pattern-either:
            - pattern: $HTML % ...
            - pattern: $HTML.format(...)
            - pattern: $HTML + ...
      - metavariable-pattern:
          language: generic
          metavariable: $HTMLSTR
          pattern: <$TAG ...
    pattern-sources:
    - patterns:
      - pattern: request.$ANYTHING
      - pattern-not: request.build_absolute_uri
    severity: WARNING
- rules:
  - id: csv-writer-injection
    languages:
    - python
    message: Detected user input into a generated CSV file using the built-in `csv`
      module. If user data is used to generate the data in this file, it is possible
      that an attacker could inject a formula when the CSV is imported into a spreadsheet
      application that runs an attacker script, which could steal data from the importing
      user or, at worst, install malware on the user's computer. `defusedcsv` is a
      drop-in replacement with the same API that will attempt to mitigate formula
      injection attempts. You can use `defusedcsv` instead of `csv` to safely generate
      CSVs.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-1236: Improper Neutralization of Formula Elements in a CSV File'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://github.com/raphaelm/defusedcsv
      - https://owasp.org/www-community/attacks/CSV_Injection
      - https://web.archive.org/web/20220516052229/https://www.contextis.com/us/blog/comma-separated-vulnerabilities
      subcategory:
      - vuln
      technology:
      - django
      - python
    mode: taint
    pattern-sinks:
    - patterns:
      - pattern-inside: '$WRITER = csv.writer(...)


          ...


          $WRITER.$WRITE(...)

          '
      - pattern: $WRITER.$WRITE(...)
      - metavariable-regex:
          metavariable: $WRITE
          regex: ^(writerow|writerows|writeheader)$
    pattern-sources:
    - patterns:
      - pattern-inside: "def $FUNC(..., $REQUEST, ...):\n  ...\n"
      - focus-metavariable: $REQUEST
      - metavariable-pattern:
          metavariable: $REQUEST
          patterns:
          - pattern: request
          - pattern-not-inside: request.build_absolute_uri
    severity: ERROR
- rules:
  - id: open-redirect
    languages:
    - python
    message: Data from request ($DATA) is passed to redirect(). This is an open redirect
      and could be exploited. Ensure you are redirecting to safe URLs by using django.utils.http.is_safe_url().
      See https://cwe.mitre.org/data/definitions/601.html for more information.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-601: URL Redirection to Untrusted Site (''Open Redirect'')'
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A01:2021 - Broken Access Control
      references:
      - https://www.djm.org.uk/posts/djangos-little-protections-word-redirect-dangers/
      - https://github.com/django/django/blob/d1b7bd030b1db111e1a3505b1fc029ab964382cc/django/utils/http.py#L231
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-not-inside: "def $FUNC(...):\n  ...\n  django.utils.http.is_safe_url(...)\n\
        \  ...\n"
    - pattern-not-inside: "def $FUNC(...):\n  ...\n  if <... django.utils.http.is_safe_url(...)\
        \ ...>:\n    ...\n"
    - pattern-not-inside: "def $FUNC(...):\n  ...\n  django.utils.http.url_has_allowed_host_and_scheme(...)\n\
        \  ...\n"
    - pattern-not-inside: "def $FUNC(...):\n  ...\n  if <... django.utils.http.url_has_allowed_host_and_scheme(...)\
        \ ...>:\n    ...\n"
    - pattern-either:
      - pattern: django.shortcuts.redirect(..., request.$W.get(...), ...)
      - pattern: django.shortcuts.redirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: django.shortcuts.redirect(..., $S % request.$W.get(...), ...)
      - pattern: django.shortcuts.redirect(..., f"...{request.$W.get(...)}...", ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.shortcuts.redirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.shortcuts.redirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.shortcuts.redirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.shortcuts.redirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.shortcuts.redirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: $A = django.shortcuts.redirect(..., request.$W.get(...), ...)
      - pattern: $A = django.shortcuts.redirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: $A = django.shortcuts.redirect(..., $S % request.$W.get(...), ...)
      - pattern: $A = django.shortcuts.redirect(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: return django.shortcuts.redirect(..., request.$W.get(...), ...)
      - pattern: return django.shortcuts.redirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: return django.shortcuts.redirect(..., $S % request.$W.get(...), ...)
      - pattern: return django.shortcuts.redirect(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: django.shortcuts.redirect(..., request.$W(...), ...)
      - pattern: django.shortcuts.redirect(..., $S.format(..., request.$W(...), ...),
          ...)
      - pattern: django.shortcuts.redirect(..., $S % request.$W(...), ...)
      - pattern: django.shortcuts.redirect(..., f"...{request.$W(...)}...", ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.shortcuts.redirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.shortcuts.redirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.shortcuts.redirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.shortcuts.redirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.shortcuts.redirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: $A = django.shortcuts.redirect(..., request.$W(...), ...)
      - pattern: $A = django.shortcuts.redirect(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: $A = django.shortcuts.redirect(..., $S % request.$W(...), ...)
      - pattern: $A = django.shortcuts.redirect(..., f"...{request.$W(...)}...", ...)
      - pattern: return django.shortcuts.redirect(..., request.$W(...), ...)
      - pattern: return django.shortcuts.redirect(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: return django.shortcuts.redirect(..., $S % request.$W(...), ...)
      - pattern: return django.shortcuts.redirect(..., f"...{request.$W(...)}...",
          ...)
      - pattern: django.shortcuts.redirect(..., request.$W[...], ...)
      - pattern: django.shortcuts.redirect(..., $S.format(..., request.$W[...], ...),
          ...)
      - pattern: django.shortcuts.redirect(..., $S % request.$W[...], ...)
      - pattern: django.shortcuts.redirect(..., f"...{request.$W[...]}...", ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.shortcuts.redirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.shortcuts.redirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.shortcuts.redirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.shortcuts.redirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.shortcuts.redirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: $A = django.shortcuts.redirect(..., request.$W[...], ...)
      - pattern: $A = django.shortcuts.redirect(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: $A = django.shortcuts.redirect(..., $S % request.$W[...], ...)
      - pattern: $A = django.shortcuts.redirect(..., f"...{request.$W[...]}...", ...)
      - pattern: return django.shortcuts.redirect(..., request.$W[...], ...)
      - pattern: return django.shortcuts.redirect(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: return django.shortcuts.redirect(..., $S % request.$W[...], ...)
      - pattern: return django.shortcuts.redirect(..., f"...{request.$W[...]}...",
          ...)
      - pattern: django.shortcuts.redirect(..., request.$W, ...)
      - pattern: django.shortcuts.redirect(..., $S.format(..., request.$W, ...), ...)
      - pattern: django.shortcuts.redirect(..., $S % request.$W, ...)
      - pattern: django.shortcuts.redirect(..., f"...{request.$W}...", ...)
      - pattern: '$DATA = request.$W

          ...

          django.shortcuts.redirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.shortcuts.redirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.shortcuts.redirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.shortcuts.redirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.shortcuts.redirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.shortcuts.redirect(..., $INTERM, ...)

          '
      - pattern: $A = django.shortcuts.redirect(..., request.$W, ...)
      - pattern: $A = django.shortcuts.redirect(..., $S.format(..., request.$W, ...),
          ...)
      - pattern: $A = django.shortcuts.redirect(..., $S % request.$W, ...)
      - pattern: $A = django.shortcuts.redirect(..., f"...{request.$W}...", ...)
      - pattern: return django.shortcuts.redirect(..., request.$W, ...)
      - pattern: return django.shortcuts.redirect(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: return django.shortcuts.redirect(..., $S % request.$W, ...)
      - pattern: return django.shortcuts.redirect(..., f"...{request.$W}...", ...)
      - pattern: django.http.HttpResponseRedirect(..., request.$W.get(...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S % request.$W.get(...), ...)
      - pattern: django.http.HttpResponseRedirect(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseRedirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseRedirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseRedirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseRedirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseRedirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseRedirect(..., request.$W.get(...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S % request.$W.get(...),
          ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., request.$W.get(...),
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S % request.$W.get(...),
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: django.http.HttpResponseRedirect(..., request.$W(...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S % request.$W(...), ...)
      - pattern: django.http.HttpResponseRedirect(..., f"...{request.$W(...)}...",
          ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseRedirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseRedirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseRedirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseRedirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseRedirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseRedirect(..., request.$W(...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S % request.$W(...),
          ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., f"...{request.$W(...)}...",
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., request.$W(...), ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S % request.$W(...),
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., f"...{request.$W(...)}...",
          ...)
      - pattern: django.http.HttpResponseRedirect(..., request.$W[...], ...)
      - pattern: django.http.HttpResponseRedirect(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S % request.$W[...], ...)
      - pattern: django.http.HttpResponseRedirect(..., f"...{request.$W[...]}...",
          ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseRedirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseRedirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseRedirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseRedirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseRedirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseRedirect(..., request.$W[...], ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S % request.$W[...],
          ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., f"...{request.$W[...]}...",
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., request.$W[...], ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S % request.$W[...],
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., f"...{request.$W[...]}...",
          ...)
      - pattern: django.http.HttpResponseRedirect(..., request.$W, ...)
      - pattern: django.http.HttpResponseRedirect(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: django.http.HttpResponseRedirect(..., $S % request.$W, ...)
      - pattern: django.http.HttpResponseRedirect(..., f"...{request.$W}...", ...)
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseRedirect(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseRedirect(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseRedirect(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseRedirect(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseRedirect(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseRedirect(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseRedirect(..., request.$W, ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., $S % request.$W, ...)
      - pattern: $A = django.http.HttpResponseRedirect(..., f"...{request.$W}...",
          ...)
      - pattern: return django.http.HttpResponseRedirect(..., request.$W, ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: return django.http.HttpResponseRedirect(..., $S % request.$W, ...)
      - pattern: return django.http.HttpResponseRedirect(..., f"...{request.$W}...",
          ...)
    - metavariable-regex:
        metavariable: $W
        regex: (?!get_full_path)
    severity: WARNING
- rules:
  - id: request-data-fileresponse
    languages:
    - python
    message: Found user-controlled request data being passed into a file open, which
      is them passed as an argument into the FileResponse. This is dangerous because
      an attacker could specify an arbitrary file to read, which could result in leaking
      important data. Be sure to validate or sanitize the user-inputted filename in
      the request data before using it in FileResponse.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory (''Path
        Traversal'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A05:2017 - Broken Access Control
      - A01:2021 - Broken Access Control
      references:
      - https://django-book.readthedocs.io/en/latest/chapter20.html#cross-site-scripting-xss
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: django.http.FileResponse(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.FileResponse(..., open($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = open($DATA, ...)

          ...

          django.http.FileResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.FileResponse(..., request.$W.get(...), ...)
      - pattern: return django.http.FileResponse(..., request.$W.get(...), ...)
      - pattern: django.http.FileResponse(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.FileResponse(..., open($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = open($DATA, ...)

          ...

          django.http.FileResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.FileResponse(..., request.$W(...), ...)
      - pattern: return django.http.FileResponse(..., request.$W(...), ...)
      - pattern: django.http.FileResponse(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.FileResponse(..., open($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = open($DATA, ...)

          ...

          django.http.FileResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.FileResponse(..., request.$W[...], ...)
      - pattern: return django.http.FileResponse(..., request.$W[...], ...)
      - pattern: django.http.FileResponse(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.http.FileResponse(..., open($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = open($DATA, ...)

          ...

          django.http.FileResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.FileResponse(..., request.$W, ...)
      - pattern: return django.http.FileResponse(..., request.$W, ...)
    severity: WARNING
- rules:
  - id: reflected-data-httpresponse
    languages:
    - python
    message: Found user-controlled request data passed into HttpResponse. This could
      be vulnerable to XSS, leading to attackers gaining access to user cookies and
      protected information. Ensure that the request data is properly escaped or sanitzed.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://django-book.readthedocs.io/en/latest/chapter20.html#cross-site-scripting-xss
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: django.http.HttpResponse(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: django.http.HttpResponse(..., $S % request.$W.get(...), ...)
      - pattern: django.http.HttpResponse(..., f"...{request.$W.get(...)}...", ...)
      - pattern: django.http.HttpResponse(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponse(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponse(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponse(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponse(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponse(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponse(..., request.$W.get(...), ...)
      - pattern: return django.http.HttpResponse(..., request.$W.get(...), ...)
      - pattern: django.http.HttpResponse(..., $S.format(..., request.$W(...), ...),
          ...)
      - pattern: django.http.HttpResponse(..., $S % request.$W(...), ...)
      - pattern: django.http.HttpResponse(..., f"...{request.$W(...)}...", ...)
      - pattern: django.http.HttpResponse(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponse(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponse(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponse(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponse(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponse(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponse(..., request.$W(...), ...)
      - pattern: return django.http.HttpResponse(..., request.$W(...), ...)
      - pattern: django.http.HttpResponse(..., $S.format(..., request.$W[...], ...),
          ...)
      - pattern: django.http.HttpResponse(..., $S % request.$W[...], ...)
      - pattern: django.http.HttpResponse(..., f"...{request.$W[...]}...", ...)
      - pattern: django.http.HttpResponse(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponse(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponse(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponse(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponse(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponse(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponse(..., request.$W[...], ...)
      - pattern: return django.http.HttpResponse(..., request.$W[...], ...)
      - pattern: django.http.HttpResponse(..., $S.format(..., request.$W, ...), ...)
      - pattern: django.http.HttpResponse(..., $S % request.$W, ...)
      - pattern: django.http.HttpResponse(..., f"...{request.$W}...", ...)
      - pattern: django.http.HttpResponse(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponse(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponse(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponse(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponse(..., f"...{$DATA}...", ...)

          '
      - pattern: $A = django.http.HttpResponse(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          $A = django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: return django.http.HttpResponse(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponse(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponse(..., $INTERM, ...)

          '
    severity: WARNING
- rules:
  - id: reflected-data-httpresponsebadrequest
    languages:
    - python
    message: Found user-controlled request data passed into a HttpResponseBadRequest.
      This could be vulnerable to XSS, leading to attackers gaining access to user
      cookies and protected information. Ensure that the request data is properly
      escaped or sanitzed.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://django-book.readthedocs.io/en/latest/chapter20.html#cross-site-scripting-xss
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: django.http.HttpResponseBadRequest(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S % request.$W.get(...),
          ...)
      - pattern: django.http.HttpResponseBadRequest(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: django.http.HttpResponseBadRequest(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseBadRequest(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseBadRequest(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseBadRequest(..., request.$W.get(...),
          ...)
      - pattern: return django.http.HttpResponseBadRequest(..., request.$W.get(...),
          ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S % request.$W(...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., f"...{request.$W(...)}...",
          ...)
      - pattern: django.http.HttpResponseBadRequest(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseBadRequest(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseBadRequest(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.http.HttpResponseBadRequest(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseBadRequest(..., request.$W(...), ...)
      - pattern: return django.http.HttpResponseBadRequest(..., request.$W(...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S % request.$W[...], ...)
      - pattern: django.http.HttpResponseBadRequest(..., f"...{request.$W[...]}...",
          ...)
      - pattern: django.http.HttpResponseBadRequest(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseBadRequest(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseBadRequest(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseBadRequest(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseBadRequest(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.http.HttpResponseBadRequest(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseBadRequest(..., request.$W[...], ...)
      - pattern: return django.http.HttpResponseBadRequest(..., request.$W[...], ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: django.http.HttpResponseBadRequest(..., $S % request.$W, ...)
      - pattern: django.http.HttpResponseBadRequest(..., f"...{request.$W}...", ...)
      - pattern: django.http.HttpResponseBadRequest(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseBadRequest(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseBadRequest(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseBadRequest(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseBadRequest(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.http.HttpResponseBadRequest(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.http.HttpResponseBadRequest(..., $INTERM, ...)

          '
      - pattern: $A = django.http.HttpResponseBadRequest(..., request.$W, ...)
      - pattern: return django.http.HttpResponseBadRequest(..., request.$W, ...)
    severity: WARNING
- rules:
  - id: request-data-write
    languages:
    - python
    message: Found user-controlled request data passed into '.write(...)'. This could
      be dangerous if a malicious actor is able to control data into sensitive files.
      For example, a malicious actor could force rolling of critical log files, or
      cause a denial-of-service by using up available disk space. Instead, ensure
      that request data is properly escaped or sanitized.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-93: Improper Neutralization of CRLF Sequences (''CRLF Injection'')'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://owasp.org/Top10/A03_2021-Injection
      subcategory:
      - vuln
      technology:
      - django
    pattern-either:
    - pattern: $F.write(..., request.$W.get(...), ...)
    - pattern: '$DATA = request.$W.get(...)

        ...

        $F.write(..., $DATA, ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $INTERM = $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $F.write(..., $B.$C(..., $DATA, ...), ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $INTERM = $B.$C(..., $DATA, ...)

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $F.write(..., $STR % $DATA, ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $INTERM = $STR % $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $F.write(..., f"...{$DATA}...", ...)

        '
    - pattern: '$DATA = request.$W.get(...)

        ...

        $INTERM = f"...{$DATA}..."

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: $A = $F.write(..., request.$W.get(...), ...)
    - pattern: return $F.write(..., request.$W.get(...), ...)
    - pattern: $F.write(..., request.$W(...), ...)
    - pattern: '$DATA = request.$W(...)

        ...

        $F.write(..., $DATA, ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $INTERM = $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $F.write(..., $B.$C(..., $DATA, ...), ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $INTERM = $B.$C(..., $DATA, ...)

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $F.write(..., $STR % $DATA, ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $INTERM = $STR % $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $F.write(..., f"...{$DATA}...", ...)

        '
    - pattern: '$DATA = request.$W(...)

        ...

        $INTERM = f"...{$DATA}..."

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: $A = $F.write(..., request.$W(...), ...)
    - pattern: return $F.write(..., request.$W(...), ...)
    - pattern: $F.write(..., request.$W[...], ...)
    - pattern: '$DATA = request.$W[...]

        ...

        $F.write(..., $DATA, ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $INTERM = $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $F.write(..., $B.$C(..., $DATA, ...), ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $INTERM = $B.$C(..., $DATA, ...)

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $F.write(..., $STR % $DATA, ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $INTERM = $STR % $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $F.write(..., f"...{$DATA}...", ...)

        '
    - pattern: '$DATA = request.$W[...]

        ...

        $INTERM = f"...{$DATA}..."

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: $A = $F.write(..., request.$W[...], ...)
    - pattern: return $F.write(..., request.$W[...], ...)
    - pattern: $F.write(..., request.$W, ...)
    - pattern: '$DATA = request.$W

        ...

        $F.write(..., $DATA, ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $INTERM = $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $F.write(..., $B.$C(..., $DATA, ...), ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $INTERM = $B.$C(..., $DATA, ...)

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $F.write(..., $STR % $DATA, ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $INTERM = $STR % $DATA

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $F.write(..., f"...{$DATA}...", ...)

        '
    - pattern: '$DATA = request.$W

        ...

        $INTERM = f"...{$DATA}..."

        ...

        $F.write(..., $INTERM, ...)

        '
    - pattern: $A = $F.write(..., request.$W, ...)
    - pattern: return $F.write(..., request.$W, ...)
    severity: WARNING
- rules:
  - id: mass-assignment
    languages:
    - python
    message: Mass assignment detected. This can result in assignment to model fields
      that are unintended and can be exploited by an attacker. Instead of using '**request.$W',
      assign each field you want to edit individually to prevent mass assignment.
      You can read more about mass assignment at https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-915: Improperly Controlled Modification of Dynamically-Determined Object
        Attributes'
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A08:2021 - Software and Data Integrity Failures
      owaspapi: 'API6: Mass Assignment'
      references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: $MODEL.objects.create(**request.$W)
    - pattern: '$OBJ.update(**request.$W)

        ...

        $OBJ.save()

        '
    severity: WARNING
- rules:
  - id: path-traversal-join
    languages:
    - python
    message: Data from request is passed to os.path.join() and to open(). This is
      a path traversal vulnerability, which can lead to sensitive data being leaked.
      To mitigate, consider using os.path.abspath or os.path.realpath or Path library.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory (''Path
        Traversal'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: LOW
      likelihood: LOW
      owasp:
      - A05:2017 - Broken Access Control
      - A01:2021 - Broken Access Control
      references:
      - https://owasp.org/www-community/attacks/Path_Traversal
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-not-inside: "def $F(...):\n  ...\n  os.path.abspath(...)\n  ...\n"
    - pattern-not-inside: "def $F(...):\n  ...\n  os.path.realpath(...)\n  ...\n"
    - pattern-either:
      - pattern: open(os.path.join(..., request.$W.get(...), ...), ...)
      - pattern: open(os.path.join(..., request.$W(...), ...), ...)
      - pattern: open(os.path.join(..., request.$W, ...), ...)
      - pattern: open(os.path.join(..., request.$W[...], ...), ...)
      - pattern: '$P = os.path.join(..., request.$W.get(...), ...)

          ...

          open($P, ...)

          '
      - pattern: '$P = os.path.join(..., request.$W(...), ...)

          ...

          open($P, ...)

          '
      - pattern: '$P = os.path.join(..., request.$W, ...)

          ...

          open($P, ...)

          '
      - pattern: '$P = os.path.join(..., request.$W[...], ...)

          ...

          open($P, ...)

          '
      - pattern: '$V = request.$W.get($X)

          ...

          $P = os.path.join(..., $V, ...)

          ...

          open($P, ...)

          '
      - pattern: '$V = request.$W($X)

          ...

          $P = os.path.join(..., $V, ...)

          ...

          open($P, ...)

          '
      - pattern: '$V = request.$W[$X]

          ...

          $P = os.path.join(..., $V, ...)

          ...

          open($P, ...)

          '
      - pattern: '$V = request.$W

          ...

          $P = os.path.join(..., $V, ...)

          ...

          open($P, ...)

          '
      - pattern: '$P = request.$W.get(...)

          ...

          open(os.path.join(..., $P, ...), ...)

          '
      - pattern: '$P = request.$W(...)

          ...

          open(os.path.join(..., $P, ...), ...)

          '
      - pattern: '$P = request.$W

          ...

          open(os.path.join(..., $P, ...), ...)

          '
      - pattern: '$P = request.$W[...]

          ...

          open(os.path.join(..., $P, ...), ...)

          '
    severity: WARNING
- rules:
  - id: path-traversal-open
    languages:
    - python
    message: Found request data in a call to 'open'. Ensure the request data is validated
      or sanitized, otherwise it could result in path traversal attacks and therefore
      sensitive data being leaked. To mitigate, consider using os.path.abspath or
      os.path.realpath or the pathlib library.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory (''Path
        Traversal'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A05:2017 - Broken Access Control
      - A01:2021 - Broken Access Control
      references:
      - https://owasp.org/www-community/attacks/Path_Traversal
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: open(..., request.$W.get(...), ...)
      - pattern: open(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: open(..., $S % request.$W.get(...), ...)
      - pattern: open(..., f"...{request.$W.get(...)}...", ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          open(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W.get(...)\n...\n$INTERM = $DATA\n...\nwith open(...,\
          \ $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W.get(...)

          ...

          open(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W.get(...)\n...\n$INTERM = $STR.format(..., $DATA,\
          \ ...)\n...\nwith open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W.get(...)

          ...

          open(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W.get(...)\n...\n$INTERM = $STR % $DATA\n...\n\
          with open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W.get(...)

          ...

          open(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W.get(...)\n...\n$INTERM = f\"...{$DATA}...\"\n\
          ...\nwith open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W.get(...)

          ...

          open(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W.get(...)\n...\n$INTERM = $STR + $DATA\n...\n\
          with open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: $A = open(..., request.$W.get(...), ...)
      - pattern: $A = open(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: $A = open(..., $S % request.$W.get(...), ...)
      - pattern: $A = open(..., f"...{request.$W.get(...)}...", ...)
      - pattern: return open(..., request.$W.get(...), ...)
      - pattern: return open(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: return open(..., $S % request.$W.get(...), ...)
      - pattern: return open(..., f"...{request.$W.get(...)}...", ...)
      - pattern: "$DATA = request.$W.get(...)\n...\nwith open(..., $DATA, ...) as\
          \ $FD:\n  ...\n"
      - pattern: open(..., request.$W(...), ...)
      - pattern: open(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: open(..., $S % request.$W(...), ...)
      - pattern: open(..., f"...{request.$W(...)}...", ...)
      - pattern: '$DATA = request.$W(...)

          ...

          open(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W(...)\n...\n$INTERM = $DATA\n...\nwith open(...,\
          \ $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W(...)

          ...

          open(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W(...)\n...\n$INTERM = $STR.format(..., $DATA,\
          \ ...)\n...\nwith open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W(...)

          ...

          open(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W(...)\n...\n$INTERM = $STR % $DATA\n...\nwith\
          \ open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W(...)

          ...

          open(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W(...)\n...\n$INTERM = f\"...{$DATA}...\"\n...\n\
          with open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W(...)

          ...

          open(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W(...)\n...\n$INTERM = $STR + $DATA\n...\nwith\
          \ open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: $A = open(..., request.$W(...), ...)
      - pattern: $A = open(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: $A = open(..., $S % request.$W(...), ...)
      - pattern: $A = open(..., f"...{request.$W(...)}...", ...)
      - pattern: return open(..., request.$W(...), ...)
      - pattern: return open(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: return open(..., $S % request.$W(...), ...)
      - pattern: return open(..., f"...{request.$W(...)}...", ...)
      - pattern: "$DATA = request.$W(...)\n...\nwith open(..., $DATA, ...) as $FD:\n\
          \  ...\n"
      - pattern: open(..., request.$W[...], ...)
      - pattern: open(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: open(..., $S % request.$W[...], ...)
      - pattern: open(..., f"...{request.$W[...]}...", ...)
      - pattern: '$DATA = request.$W[...]

          ...

          open(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W[...]\n...\n$INTERM = $DATA\n...\nwith open(...,\
          \ $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W[...]

          ...

          open(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W[...]\n...\n$INTERM = $STR.format(..., $DATA,\
          \ ...)\n...\nwith open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W[...]

          ...

          open(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W[...]\n...\n$INTERM = $STR % $DATA\n...\nwith\
          \ open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W[...]

          ...

          open(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W[...]\n...\n$INTERM = f\"...{$DATA}...\"\n...\n\
          with open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W[...]

          ...

          open(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W[...]\n...\n$INTERM = $STR + $DATA\n...\nwith\
          \ open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: $A = open(..., request.$W[...], ...)
      - pattern: $A = open(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: $A = open(..., $S % request.$W[...], ...)
      - pattern: $A = open(..., f"...{request.$W[...]}...", ...)
      - pattern: return open(..., request.$W[...], ...)
      - pattern: return open(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: return open(..., $S % request.$W[...], ...)
      - pattern: return open(..., f"...{request.$W[...]}...", ...)
      - pattern: "$DATA = request.$W[...]\n...\nwith open(..., $DATA, ...) as $FD:\n\
          \  ...\n"
      - pattern: open(..., request.$W, ...)
      - pattern: open(..., $S.format(..., request.$W, ...), ...)
      - pattern: open(..., $S % request.$W, ...)
      - pattern: open(..., f"...{request.$W}...", ...)
      - pattern: '$DATA = request.$W

          ...

          open(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W\n...\n$INTERM = $DATA\n...\nwith open(..., $INTERM,\
          \ ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W

          ...

          open(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W\n...\n$INTERM = $STR.format(..., $DATA, ...)\n\
          ...\nwith open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W

          ...

          open(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W\n...\n$INTERM = $STR % $DATA\n...\nwith open(...,\
          \ $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W

          ...

          open(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W\n...\n$INTERM = f\"...{$DATA}...\"\n...\nwith\
          \ open(..., $INTERM, ...) as $FD:\n  ...\n"
      - pattern: '$DATA = request.$W

          ...

          open(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          open(..., $INTERM, ...)

          '
      - pattern: "$DATA = request.$W\n...\n$INTERM = $STR + $DATA\n...\nwith open(...,\
          \ $INTERM, ...) as $FD:\n  ...\n"
      - pattern: $A = open(..., request.$W, ...)
      - pattern: $A = open(..., $S.format(..., request.$W, ...), ...)
      - pattern: $A = open(..., $S % request.$W, ...)
      - pattern: $A = open(..., f"...{request.$W}...", ...)
      - pattern: return open(..., request.$W, ...)
      - pattern: return open(..., $S.format(..., request.$W, ...), ...)
      - pattern: return open(..., $S % request.$W, ...)
      - pattern: return open(..., f"...{request.$W}...", ...)
      - pattern: "$DATA = request.$W\n...\nwith open(..., $DATA, ...) as $FD:\n  ...\n"
    severity: WARNING
- rules:
  - id: path-traversal-file-name
    languages:
    - python
    message: Data from request is passed to a file name `$FILE`. This is a path traversal
      vulnerability, which can lead to sensitive data being leaked. To mitigate, consider
      using os.path.abspath or os.path.realpath or the pathlib library.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory (''Path
        Traversal'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A05:2017 - Broken Access Control
      - A01:2021 - Broken Access Control
      references:
      - https://owasp.org/www-community/attacks/Path_Traversal
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-not-inside: "def $F(...):\n  ...\n  os.path.realpath(...)\n  ...\n"
    - pattern-not-inside: "def $F(...):\n  ...\n  os.path.abspath(...)\n  ...\n"
    - pattern-either:
      - pattern: '$V = request.$W.get($X)

          ...

          $FILE % ($V)

          '
      - pattern: '$V = request.$W[$X]

          ...

          $FILE % ($V)

          '
      - pattern: '$V = request.$W($X)

          ...

          $FILE % ($V)

          '
      - pattern: '$V = request.$W

          ...

          $FILE % ($V)

          # match format use cases

          '
      - pattern: '$V = request.$W.get($X)

          ...

          $FILE.format(..., $V, ...)

          '
      - pattern: '$V = request.$W[$X]

          ...

          $FILE.format(..., $V, ...)

          '
      - pattern: '$V = request.$W($X)

          ...

          $FILE.format(..., $V, ...)

          '
      - pattern: '$V = request.$W

          ...

          $FILE.format(..., $V, ...)

          '
    - metavariable-regex:
        metavariable: $FILE
        regex: .*\.(log|zip|txt|csv|xml|html).*
    severity: WARNING
- rules:
  - id: xss-html-email-body
    languages:
    - python
    message: Found request data in an EmailMessage that is set to use HTML. This is
      dangerous because HTML emails are susceptible to XSS. An attacker could inject
      data into this HTML email, causing XSS.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream
        Component (''Injection'')'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://www.damonkohler.com/2008/12/email-injection.html
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n  $EMAIL.content_subtype = \"html\"\
        \n  ...\n"
    - pattern-either:
      - pattern: django.core.mail.EmailMessage($SUBJ, request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $B.$C(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $B.$C(..., $DATA, ...)

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.EmailMessage($SUBJ, f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: $A = django.core.mail.EmailMessage($SUBJ, request.$W.get(...), ...)
      - pattern: return django.core.mail.EmailMessage($SUBJ, request.$W.get(...),
          ...)
      - pattern: django.core.mail.EmailMessage($SUBJ, request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $B.$C(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $B.$C(..., $DATA, ...)

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.EmailMessage($SUBJ, $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.EmailMessage($SUBJ, f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: $A = django.core.mail.EmailMessage($SUBJ, request.$W(...), ...)
      - pattern: return django.core.mail.EmailMessage($SUBJ, request.$W(...), ...)
      - pattern: django.core.mail.EmailMessage($SUBJ, request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.EmailMessage($SUBJ, $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.EmailMessage($SUBJ, $B.$C(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $B.$C(..., $DATA, ...)

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.EmailMessage($SUBJ, $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.EmailMessage($SUBJ, f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: $A = django.core.mail.EmailMessage($SUBJ, request.$W[...], ...)
      - pattern: return django.core.mail.EmailMessage($SUBJ, request.$W[...], ...)
      - pattern: django.core.mail.EmailMessage($SUBJ, request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.EmailMessage($SUBJ, $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.EmailMessage($SUBJ, $B.$C(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $B.$C(..., $DATA, ...)

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.EmailMessage($SUBJ, $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.EmailMessage($SUBJ, f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.EmailMessage($SUBJ, $INTERM, ...)

          '
      - pattern: $A = django.core.mail.EmailMessage($SUBJ, request.$W, ...)
      - pattern: return django.core.mail.EmailMessage($SUBJ, request.$W, ...)
    severity: WARNING
- rules:
  - id: xss-send-mail-html-message
    languages:
    - python
    message: Found request data in 'send_mail(...)' that uses 'html_message'. This
      is dangerous because HTML emails are susceptible to XSS. An attacker could inject
      data into this HTML email, causing XSS.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream
        Component (''Injection'')'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://www.damonkohler.com/2008/12/email-injection.html
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: django.core.mail.send_mail(..., html_message=request.$W.get(...),
          ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.send_mail(..., html_message=$DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR.format(..., $DATA, ...),
          ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.send_mail(..., html_message=f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: $A = django.core.mail.send_mail(..., html_message=request.$W.get(...),
          ...)
      - pattern: return django.core.mail.send_mail(..., html_message=request.$W.get(...),
          ...)
      - pattern: django.core.mail.send_mail(..., html_message=request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.send_mail(..., html_message=$DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR.format(..., $DATA, ...),
          ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.send_mail(..., html_message=f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.core.mail.send_mail(..., html_message=$STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: $A = django.core.mail.send_mail(..., html_message=request.$W(...),
          ...)
      - pattern: return django.core.mail.send_mail(..., html_message=request.$W(...),
          ...)
      - pattern: django.core.mail.send_mail(..., html_message=request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.send_mail(..., html_message=$DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.send_mail(..., html_message=$STR.format(..., $DATA, ...),
          ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.send_mail(..., html_message=$STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.send_mail(..., html_message=f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.core.mail.send_mail(..., html_message=$STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: $A = django.core.mail.send_mail(..., html_message=request.$W[...],
          ...)
      - pattern: return django.core.mail.send_mail(..., html_message=request.$W[...],
          ...)
      - pattern: django.core.mail.send_mail(..., html_message=request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.send_mail(..., html_message=$DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.send_mail(..., html_message=$STR.format(..., $DATA, ...),
          ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.send_mail(..., html_message=$STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.send_mail(..., html_message=f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.core.mail.send_mail(..., html_message=$STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.core.mail.send_mail(..., html_message=$INTERM, ...)

          '
      - pattern: $A = django.core.mail.send_mail(..., html_message=request.$W, ...)
      - pattern: return django.core.mail.send_mail(..., html_message=request.$W, ...)
    severity: WARNING
- rules:
  - id: subprocess-injection
    languages:
    - python
    message: Detected user input entering a `subprocess` call unsafely. This could
      result in a command injection vulnerability. An attacker could use this vulnerability
      to execute arbitrary commands on the host, which allows them to download malware,
      scan sensitive data, or run any command they wish on the server. Do not let
      users choose the command to run. In general, prefer to use Python API versions
      of system commands. If you must use subprocess, use a dictionary to allowlist
      a set of commands.
    metadata:
      category: security
      confidence: HIGH
      cwe:
      - 'CWE-78: Improper Neutralization of Special Elements used in an OS Command
        (''OS Command Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://semgrep.dev/docs/cheat-sheets/python-command-injection/
      subcategory:
      - vuln
      technology:
      - flask
    mode: taint
    options:
      symbolic_propagation: true
    pattern-sanitizers:
    - patterns:
      - pattern: $DICT[$KEY]
      - focus-metavariable: $KEY
    pattern-sinks:
    - patterns:
      - pattern-either:
        - patterns:
          - pattern: subprocess.$FUNC(...)
          - pattern-not: subprocess.$FUNC("...", ...)
          - pattern-not: subprocess.$FUNC(["...", ...], ...)
          - pattern-not-inside: '$CMD = ["...", ...]

              ...

              subprocess.$FUNC($CMD, ...)

              '
        - patterns:
          - pattern: subprocess.$FUNC(["$SHELL", "-c", ...], ...)
          - metavariable-regex:
              metavariable: $SHELL
              regex: ^(sh|bash|ksh|csh|tcsh|zsh)$
        - patterns:
          - pattern: subprocess.$FUNC(["$INTERPRETER", ...], ...)
          - metavariable-regex:
              metavariable: $INTERPRETER
              regex: ^(python|python\d)$
    pattern-sources:
    - patterns:
      - pattern-inside: "def $FUNC(..., $REQUEST, ...):\n  ...\n"
      - focus-metavariable: $REQUEST
      - metavariable-pattern:
          metavariable: $REQUEST
          patterns:
          - pattern: request
          - pattern-not-inside: request.build_absolute_uri
    severity: ERROR
- rules:
  - id: command-injection-os-system
    languages:
    - python
    message: Request data detected in os.system. This could be vulnerable to a command
      injection and should be avoided. If this must be done, use the 'subprocess'
      module instead and pass the arguments as a list. See https://owasp.org/www-community/attacks/Command_Injection
      for more information.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-78: Improper Neutralization of Special Elements used in an OS Command
        (''OS Command Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://owasp.org/www-community/attacks/Command_Injection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: os.system(..., request.$W.get(...), ...)
      - pattern: os.system(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: os.system(..., $S % request.$W.get(...), ...)
      - pattern: os.system(..., f"...{request.$W.get(...)}...", ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          os.system(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          os.system(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          os.system(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          os.system(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          os.system(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: $A = os.system(..., request.$W.get(...), ...)
      - pattern: $A = os.system(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: $A = os.system(..., $S % request.$W.get(...), ...)
      - pattern: $A = os.system(..., f"...{request.$W.get(...)}...", ...)
      - pattern: return os.system(..., request.$W.get(...), ...)
      - pattern: return os.system(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: return os.system(..., $S % request.$W.get(...), ...)
      - pattern: return os.system(..., f"...{request.$W.get(...)}...", ...)
      - pattern: os.system(..., request.$W(...), ...)
      - pattern: os.system(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: os.system(..., $S % request.$W(...), ...)
      - pattern: os.system(..., f"...{request.$W(...)}...", ...)
      - pattern: '$DATA = request.$W(...)

          ...

          os.system(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          os.system(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          os.system(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          os.system(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          os.system(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: $A = os.system(..., request.$W(...), ...)
      - pattern: $A = os.system(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: $A = os.system(..., $S % request.$W(...), ...)
      - pattern: $A = os.system(..., f"...{request.$W(...)}...", ...)
      - pattern: return os.system(..., request.$W(...), ...)
      - pattern: return os.system(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: return os.system(..., $S % request.$W(...), ...)
      - pattern: return os.system(..., f"...{request.$W(...)}...", ...)
      - pattern: os.system(..., request.$W[...], ...)
      - pattern: os.system(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: os.system(..., $S % request.$W[...], ...)
      - pattern: os.system(..., f"...{request.$W[...]}...", ...)
      - pattern: '$DATA = request.$W[...]

          ...

          os.system(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          os.system(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          os.system(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          os.system(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          os.system(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: $A = os.system(..., request.$W[...], ...)
      - pattern: $A = os.system(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: $A = os.system(..., $S % request.$W[...], ...)
      - pattern: $A = os.system(..., f"...{request.$W[...]}...", ...)
      - pattern: return os.system(..., request.$W[...], ...)
      - pattern: return os.system(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: return os.system(..., $S % request.$W[...], ...)
      - pattern: return os.system(..., f"...{request.$W[...]}...", ...)
      - pattern: os.system(..., request.$W, ...)
      - pattern: os.system(..., $S.format(..., request.$W, ...), ...)
      - pattern: os.system(..., $S % request.$W, ...)
      - pattern: os.system(..., f"...{request.$W}...", ...)
      - pattern: '$DATA = request.$W

          ...

          os.system(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          os.system(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          os.system(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          os.system(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          os.system(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          os.system(..., $INTERM, ...)

          '
      - pattern: $A = os.system(..., request.$W, ...)
      - pattern: $A = os.system(..., $S.format(..., request.$W, ...), ...)
      - pattern: $A = os.system(..., $S % request.$W, ...)
      - pattern: $A = os.system(..., f"...{request.$W}...", ...)
      - pattern: return os.system(..., request.$W, ...)
      - pattern: return os.system(..., $S.format(..., request.$W, ...), ...)
      - pattern: return os.system(..., $S % request.$W, ...)
      - pattern: return os.system(..., f"...{request.$W}...", ...)
    severity: ERROR
- rules:
  - id: ssrf-injection-requests
    languages:
    - python
    message: Data from request object is passed to a new server-side request. This
      could lead to a server-side request forgery (SSRF). To mitigate, ensure that
      schemes and hosts are validated against an allowlist, do not forward the response
      to the user, and ensure proper authentication and transport-layer security in
      the proxied request. See https://owasp.org/www-community/attacks/Server_Side_Request_Forgery
      to learn more about SSRF vulnerabilities.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-918: Server-Side Request Forgery (SSRF)'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A10:2021 - Server-Side Request Forgery (SSRF)
      references:
      - https://owasp.org/www-community/attacks/Server_Side_Request_Forgery
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: requests.$METHOD(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: requests.$METHOD(..., $S % request.$W.get(...), ...)
      - pattern: requests.$METHOD(..., f"...{request.$W.get(...)}...", ...)
      - pattern: requests.$METHOD(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          requests.$METHOD(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          requests.$METHOD(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          requests.$METHOD(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          requests.$METHOD(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          requests.$METHOD(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: $A = requests.$METHOD(..., request.$W.get(...), ...)
      - pattern: return requests.$METHOD(..., request.$W.get(...), ...)
      - pattern: requests.$METHOD(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: requests.$METHOD(..., $S % request.$W(...), ...)
      - pattern: requests.$METHOD(..., f"...{request.$W(...)}...", ...)
      - pattern: requests.$METHOD(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          requests.$METHOD(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          requests.$METHOD(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          requests.$METHOD(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          requests.$METHOD(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          requests.$METHOD(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: $A = requests.$METHOD(..., request.$W(...), ...)
      - pattern: return requests.$METHOD(..., request.$W(...), ...)
      - pattern: requests.$METHOD(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: requests.$METHOD(..., $S % request.$W[...], ...)
      - pattern: requests.$METHOD(..., f"...{request.$W[...]}...", ...)
      - pattern: requests.$METHOD(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          requests.$METHOD(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          requests.$METHOD(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          requests.$METHOD(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          requests.$METHOD(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          requests.$METHOD(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: $A = requests.$METHOD(..., request.$W[...], ...)
      - pattern: return requests.$METHOD(..., request.$W[...], ...)
      - pattern: requests.$METHOD(..., $S.format(..., request.$W, ...), ...)
      - pattern: requests.$METHOD(..., $S % request.$W, ...)
      - pattern: requests.$METHOD(..., f"...{request.$W}...", ...)
      - pattern: requests.$METHOD(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          requests.$METHOD(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          requests.$METHOD(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          requests.$METHOD(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          requests.$METHOD(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          requests.$METHOD(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          requests.$METHOD(..., $INTERM, ...)

          '
      - pattern: $A = requests.$METHOD(..., request.$W, ...)
      - pattern: return requests.$METHOD(..., request.$W, ...)
    severity: ERROR
- rules:
  - id: ssrf-injection-urllib
    languages:
    - python
    message: Data from request object is passed to a new server-side request. This
      could lead to a server-side request forgery (SSRF), which could result in attackers
      gaining access to private organization data. To mitigate, ensure that schemes
      and hosts are validated against an allowlist, do not forward the response to
      the user, and ensure proper authentication and transport-layer security in the
      proxied request.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-918: Server-Side Request Forgery (SSRF)'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A10:2021 - Server-Side Request Forgery (SSRF)
      references:
      - https://owasp.org/www-community/attacks/Server_Side_Request_Forgery
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: urllib.request.urlopen(..., $S.format(..., request.$W.get(...), ...),
          ...)
      - pattern: urllib.request.urlopen(..., $S % request.$W.get(...), ...)
      - pattern: urllib.request.urlopen(..., f"...{request.$W.get(...)}...", ...)
      - pattern: urllib.request.urlopen(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          urllib.request.urlopen(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          urllib.request.urlopen(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          urllib.request.urlopen(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          urllib.request.urlopen(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          urllib.request.urlopen(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: $A = urllib.request.urlopen(..., request.$W.get(...), ...)
      - pattern: return urllib.request.urlopen(..., request.$W.get(...), ...)
      - pattern: urllib.request.urlopen(..., $S.format(..., request.$W(...), ...),
          ...)
      - pattern: urllib.request.urlopen(..., $S % request.$W(...), ...)
      - pattern: urllib.request.urlopen(..., f"...{request.$W(...)}...", ...)
      - pattern: urllib.request.urlopen(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          urllib.request.urlopen(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          urllib.request.urlopen(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          urllib.request.urlopen(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          urllib.request.urlopen(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          urllib.request.urlopen(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: $A = urllib.request.urlopen(..., request.$W(...), ...)
      - pattern: return urllib.request.urlopen(..., request.$W(...), ...)
      - pattern: urllib.request.urlopen(..., $S.format(..., request.$W[...], ...),
          ...)
      - pattern: urllib.request.urlopen(..., $S % request.$W[...], ...)
      - pattern: urllib.request.urlopen(..., f"...{request.$W[...]}...", ...)
      - pattern: urllib.request.urlopen(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          urllib.request.urlopen(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          urllib.request.urlopen(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          urllib.request.urlopen(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          urllib.request.urlopen(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          urllib.request.urlopen(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: $A = urllib.request.urlopen(..., request.$W[...], ...)
      - pattern: return urllib.request.urlopen(..., request.$W[...], ...)
      - pattern: urllib.request.urlopen(..., $S.format(..., request.$W, ...), ...)
      - pattern: urllib.request.urlopen(..., $S % request.$W, ...)
      - pattern: urllib.request.urlopen(..., f"...{request.$W}...", ...)
      - pattern: urllib.request.urlopen(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          urllib.request.urlopen(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          urllib.request.urlopen(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          urllib.request.urlopen(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          urllib.request.urlopen(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          urllib.request.urlopen(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          urllib.request.urlopen(..., $INTERM, ...)

          '
      - pattern: $A = urllib.request.urlopen(..., request.$W, ...)
      - pattern: return urllib.request.urlopen(..., request.$W, ...)
    severity: ERROR
- rules:
  - id: globals-misuse-code-execution
    languages:
    - python
    message: Found request data as an index to 'globals()'. This is extremely dangerous
      because it allows an attacker to execute arbitrary code on the system. Refactor
      your code not to use 'globals()'.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-96: Improper Neutralization of Directives in Statically Saved Code (''Static
        Code Injection'')'
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A03:2021 - Injection
      references:
      - https://github.com/mpirnat/lets-be-bad-guys/blob/d92768fb3ade32956abd53bd6bb06e19d634a084/badguys/vulnerable/views.py#L181-L186
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals().get($DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals().get("..." % $DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals().get(f"...{$DATA}...", ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals().get("...".format(..., $DATA, ...), ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals()[$DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals()["..." % $DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals()[f"...{$DATA}..."]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = globals()["...".format(..., $DATA, ...)]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals().get($DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals().get("..." % $DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals().get(f"...{$DATA}...", ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals().get("...".format(..., $DATA, ...), ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals()[$DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals()["..." % $DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals()[f"...{$DATA}..."]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = globals()["...".format(..., $DATA, ...)]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals().get($DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals().get("..." % $DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals().get(f"...{$DATA}...", ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals().get("...".format(..., $DATA, ...), ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals()[$DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals()["..." % $DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals()[f"...{$DATA}..."]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = globals()["...".format(..., $DATA, ...)]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals().get($DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals().get("..." % $DATA, ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals().get(f"...{$DATA}...", ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals().get("...".format(..., $DATA, ...), ...)

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals()[$DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals()["..." % $DATA]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals()[f"...{$DATA}..."]

          ...

          $INTERM(...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = globals()["...".format(..., $DATA, ...)]

          ...

          $INTERM(...)

          '
    severity: WARNING
- rules:
  - id: user-exec-format-string
    languages:
    - python
    message: Found user data in a call to 'exec'. This is extremely dangerous because
      it can enable an attacker to execute arbitrary remote code on the system. Instead,
      refactor your code to not use 'eval' and instead use a safe library for the
      specific functionality you need.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code
        (''Eval Injection'')'
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://owasp.org/www-community/attacks/Code_Injection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-either:
      - pattern: exec(..., $STR % request.$W.get(...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          exec(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = $STR % $V

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., "..." % request.$W(...), ...)
      - pattern: '$V = request.$W(...)

          ...

          exec(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = $STR % $V

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., $STR % request.$W[...], ...)
      - pattern: '$V = request.$W[...]

          ...

          exec(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = $STR % $V

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., $STR.format(..., request.$W.get(...), ...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          exec(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = $STR.format(..., $V, ...)

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., $STR.format(..., request.$W(...), ...), ...)
      - pattern: '$V = request.$W(...)

          ...

          exec(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = $STR.format(..., $V, ...)

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., $STR.format(..., request.$W[...], ...), ...)
      - pattern: '$V = request.$W[...]

          ...

          exec(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = $STR.format(..., $V, ...)

          ...

          exec(..., $S, ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          exec(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = f"...{$V}..."

          ...

          exec(..., $S, ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          exec(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = f"...{$V}..."

          ...

          exec(..., $S, ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          exec(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = f"...{$V}..."

          ...

          exec(..., $S, ...)

          '
      - pattern: exec(..., base64.decodestring($S.format(..., request.$W.get(...),
          ...), ...), ...)
      - pattern: exec(..., base64.decodestring($S % request.$W.get(...), ...), ...)
      - pattern: exec(..., base64.decodestring(f"...{request.$W.get(...)}...", ...),
          ...)
      - pattern: exec(..., base64.decodestring(request.$W.get(...), ...), ...)
      - pattern: exec(..., base64.decodestring(bytes($S.format(..., request.$W.get(...),
          ...), ...), ...), ...)
      - pattern: exec(..., base64.decodestring(bytes($S % request.$W.get(...), ...),
          ...), ...)
      - pattern: exec(..., base64.decodestring(bytes(f"...{request.$W.get(...)}...",
          ...), ...), ...)
      - pattern: exec(..., base64.decodestring(bytes(request.$W.get(...), ...), ...),
          ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          exec(..., base64.decodestring($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = base64.decodestring($DATA, ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          exec(..., base64.decodestring(bytes($DATA, ...), ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = base64.decodestring(bytes($DATA, ...), ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          exec(..., base64.decodestring($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = base64.decodestring($DATA, ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          exec(..., base64.decodestring(bytes($DATA, ...), ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = base64.decodestring(bytes($DATA, ...), ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          exec(..., base64.decodestring($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = base64.decodestring($DATA, ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          exec(..., base64.decodestring(bytes($DATA, ...), ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = base64.decodestring(bytes($DATA, ...), ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          exec(..., base64.decodestring($DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = base64.decodestring($DATA, ...)

          ...

          exec(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          exec(..., base64.decodestring(bytes($DATA, ...), ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = base64.decodestring(bytes($DATA, ...), ...)

          ...

          exec(..., $INTERM, ...)

          '
    severity: WARNING
- rules:
  - id: user-eval
    languages:
    - python
    message: Found user data in a call to 'eval'. This is extremely dangerous because
      it can enable an attacker to execute arbitrary remote code on the system. Instead,
      refactor your code to not use 'eval' and instead use a safe library for the
      specific functionality you need.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code
        (''Eval Injection'')'
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html
      - https://owasp.org/www-community/attacks/Code_Injection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-either:
      - pattern: eval(..., request.$W.get(...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          eval(..., $V, ...)

          '
      - pattern: eval(..., request.$W(...), ...)
      - pattern: '$V = request.$W(...)

          ...

          eval(..., $V, ...)

          '
      - pattern: eval(..., request.$W[...], ...)
      - pattern: '$V = request.$W[...]

          ...

          eval(..., $V, ...)

          '
    severity: WARNING
- rules:
  - id: user-eval-format-string
    languages:
    - python
    message: Found user data in a call to 'eval'. This is extremely dangerous because
      it can enable an attacker to execute remote code. See https://owasp.org/www-community/attacks/Code_Injection
      for more information.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code
        (''Eval Injection'')'
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-either:
      - pattern: eval(..., $STR % request.$W.get(...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          eval(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = $STR % $V

          ...

          eval(..., $S, ...)

          '
      - pattern: eval(..., "..." % request.$W(...), ...)
      - pattern: '$V = request.$W(...)

          ...

          eval(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = $STR % $V

          ...

          eval(..., $S, ...)

          '
      - pattern: eval(..., $STR % request.$W[...], ...)
      - pattern: '$V = request.$W[...]

          ...

          eval(..., $STR % $V, ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = $STR % $V

          ...

          eval(..., $S, ...)

          '
      - pattern: eval(..., $STR.format(..., request.$W.get(...), ...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          eval(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = $STR.format(..., $V, ...)

          ...

          eval(..., $S, ...)

          '
      - pattern: eval(..., $STR.format(..., request.$W(...), ...), ...)
      - pattern: '$V = request.$W(...)

          ...

          eval(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = $STR.format(..., $V, ...)

          ...

          eval(..., $S, ...)

          '
      - pattern: eval(..., $STR.format(..., request.$W[...], ...), ...)
      - pattern: '$V = request.$W[...]

          ...

          eval(..., $STR.format(..., $V, ...), ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = $STR.format(..., $V, ...)

          ...

          eval(..., $S, ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          eval(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W.get(...)

          ...

          $S = f"...{$V}..."

          ...

          eval(..., $S, ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          eval(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W(...)

          ...

          $S = f"...{$V}..."

          ...

          eval(..., $S, ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          eval(..., f"...{$V}...", ...)

          '
      - pattern: '$V = request.$W[...]

          ...

          $S = f"...{$V}..."

          ...

          eval(..., $S, ...)

          '
    severity: WARNING
- rules:
  - id: user-exec
    languages:
    - python
    message: Found user data in a call to 'exec'. This is extremely dangerous because
      it can enable an attacker to execute arbitrary remote code on the system. Instead,
      refactor your code to not use 'eval' and instead use a safe library for the
      specific functionality you need.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code
        (''Eval Injection'')'
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A03:2021 - Injection
      references:
      - https://owasp.org/www-community/attacks/Code_Injection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $F(...):\n  ...\n"
    - pattern-either:
      - pattern: exec(..., request.$W.get(...), ...)
      - pattern: '$V = request.$W.get(...)

          ...

          exec(..., $V, ...)

          '
      - pattern: exec(..., request.$W(...), ...)
      - pattern: '$V = request.$W(...)

          ...

          exec(..., $V, ...)

          '
      - pattern: exec(..., request.$W[...], ...)
      - pattern: '$V = request.$W[...]

          ...

          exec(..., $V, ...)

          '
      - pattern: 'loop = asyncio.get_running_loop()

          ...

          await loop.run_in_executor(None, exec, request.$W[...])

          '
      - pattern: '$V = request.$W[...]

          ...

          loop = asyncio.get_running_loop()

          ...

          await loop.run_in_executor(None, exec, $V)

          '
      - pattern: 'loop = asyncio.get_running_loop()

          ...

          await loop.run_in_executor(None, exec, request.$W.get(...))

          '
      - pattern: '$V = request.$W.get(...)

          ...

          loop = asyncio.get_running_loop()

          ...

          await loop.run_in_executor(None, exec, $V)

          '
    severity: WARNING
- rules:
  - id: sql-injection-using-raw
    languages:
    - python
    message: Data that is possible user-controlled from a python request is passed
      to `raw()`. This could lead to SQL injection and attackers gaining access to
      protected information. Instead, use django's QuerySets, which are built with
      query parameterization and therefore not vulnerable to sql injection. For example,
      you could use `Entry.objects.filter(date=2006)`.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/topics/security/#sql-injection-protection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: $MODEL.objects.raw(..., $S.format(..., request.$W.get(...), ...),
          ...)
      - pattern: $MODEL.objects.raw(..., $S % request.$W.get(...), ...)
      - pattern: $MODEL.objects.raw(..., f"...{request.$W.get(...)}...", ...)
      - pattern: $MODEL.objects.raw(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: $A = $MODEL.objects.raw(..., request.$W.get(...), ...)
      - pattern: return $MODEL.objects.raw(..., request.$W.get(...), ...)
      - pattern: $MODEL.objects.raw(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: $MODEL.objects.raw(..., $S % request.$W(...), ...)
      - pattern: $MODEL.objects.raw(..., f"...{request.$W(...)}...", ...)
      - pattern: $MODEL.objects.raw(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: $A = $MODEL.objects.raw(..., request.$W(...), ...)
      - pattern: return $MODEL.objects.raw(..., request.$W(...), ...)
      - pattern: $MODEL.objects.raw(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: $MODEL.objects.raw(..., $S % request.$W[...], ...)
      - pattern: $MODEL.objects.raw(..., f"...{request.$W[...]}...", ...)
      - pattern: $MODEL.objects.raw(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: $A = $MODEL.objects.raw(..., request.$W[...], ...)
      - pattern: return $MODEL.objects.raw(..., request.$W[...], ...)
      - pattern: $MODEL.objects.raw(..., $S.format(..., request.$W, ...), ...)
      - pattern: $MODEL.objects.raw(..., $S % request.$W, ...)
      - pattern: $MODEL.objects.raw(..., f"...{request.$W}...", ...)
      - pattern: $MODEL.objects.raw(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.raw(..., $INTERM, ...)

          '
      - pattern: $A = $MODEL.objects.raw(..., request.$W, ...)
      - pattern: return $MODEL.objects.raw(..., request.$W, ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.raw($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.raw($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.raw($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.raw($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.raw($INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.raw($INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.raw($INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.raw($INTERM, ...)

          '
    severity: WARNING
- rules:
  - id: sql-injection-db-cursor-execute
    languages:
    - python
    message: User-controlled data from a request is passed to 'execute()'. This could
      lead to a SQL injection and therefore protected information could be leaked.
      Instead, use django's QuerySets, which are built with query parameterization
      and therefore not vulnerable to sql injection. For example, you could use `Entry.objects.filter(date=2006)`.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/topics/security/#sql-injection-protection
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: $CURSOR.execute(..., $S.format(..., request.$W.get(...), ...), ...)
      - pattern: $CURSOR.execute(..., $S % request.$W.get(...), ...)
      - pattern: $CURSOR.execute(..., f"...{request.$W.get(...)}...", ...)
      - pattern: $CURSOR.execute(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: $A = $CURSOR.execute(..., request.$W.get(...), ...)
      - pattern: return $CURSOR.execute(..., request.$W.get(...), ...)
      - pattern: $CURSOR.execute(..., $S.format(..., request.$W(...), ...), ...)
      - pattern: $CURSOR.execute(..., $S % request.$W(...), ...)
      - pattern: $CURSOR.execute(..., f"...{request.$W(...)}...", ...)
      - pattern: $CURSOR.execute(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: $A = $CURSOR.execute(..., request.$W(...), ...)
      - pattern: return $CURSOR.execute(..., request.$W(...), ...)
      - pattern: $CURSOR.execute(..., $S.format(..., request.$W[...], ...), ...)
      - pattern: $CURSOR.execute(..., $S % request.$W[...], ...)
      - pattern: $CURSOR.execute(..., f"...{request.$W[...]}...", ...)
      - pattern: $CURSOR.execute(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: $A = $CURSOR.execute(..., request.$W[...], ...)
      - pattern: return $CURSOR.execute(..., request.$W[...], ...)
      - pattern: $CURSOR.execute(..., $S.format(..., request.$W, ...), ...)
      - pattern: $CURSOR.execute(..., $S % request.$W, ...)
      - pattern: $CURSOR.execute(..., f"...{request.$W}...", ...)
      - pattern: $CURSOR.execute(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          $CURSOR.execute(..., $INTERM, ...)

          '
      - pattern: $A = $CURSOR.execute(..., request.$W, ...)
      - pattern: return $CURSOR.execute(..., request.$W, ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $CURSOR.execute($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $CURSOR.execute($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $CURSOR.execute($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $CURSOR.execute($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $CURSOR.execute($INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $CURSOR.execute($INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $CURSOR.execute($INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $CURSOR.execute($INTERM, ...)'
    severity: WARNING
- rules:
  - id: sql-injection-using-rawsql
    languages:
    - python
    message: User-controlled data from request is passed to 'RawSQL()'. This could
      lead to a SQL injection and therefore protected information could be leaked.
      Instead, use parameterized queries or escape the user-controlled data by using
      `params` and not using quote placeholders in the SQL string.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/expressions/#django.db.models.expressions.RawSQL
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: django.db.models.expressions.RawSQL(..., $S.format(..., request.$W.get(...),
          ...), ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S % request.$W.get(...),
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., f"...{request.$W.get(...)}...",
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., request.$W.get(...), ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: $A = django.db.models.expressions.RawSQL(..., request.$W.get(...),
          ...)
      - pattern: return django.db.models.expressions.RawSQL(..., request.$W.get(...),
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S.format(..., request.$W(...),
          ...), ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S % request.$W(...), ...)
      - pattern: django.db.models.expressions.RawSQL(..., f"...{request.$W(...)}...",
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., request.$W(...), ...)
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: $A = django.db.models.expressions.RawSQL(..., request.$W(...), ...)
      - pattern: return django.db.models.expressions.RawSQL(..., request.$W(...),
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S.format(..., request.$W[...],
          ...), ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S % request.$W[...], ...)
      - pattern: django.db.models.expressions.RawSQL(..., f"...{request.$W[...]}...",
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., request.$W[...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: $A = django.db.models.expressions.RawSQL(..., request.$W[...], ...)
      - pattern: return django.db.models.expressions.RawSQL(..., request.$W[...],
          ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S.format(..., request.$W,
          ...), ...)
      - pattern: django.db.models.expressions.RawSQL(..., $S % request.$W, ...)
      - pattern: django.db.models.expressions.RawSQL(..., f"...{request.$W}...", ...)
      - pattern: django.db.models.expressions.RawSQL(..., request.$W, ...)
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL(..., $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL(..., $STR.format(..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL(..., $STR % $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL(..., f"...{$DATA}...", ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL(..., $STR + $DATA, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          django.db.models.expressions.RawSQL(..., $INTERM, ...)

          '
      - pattern: $A = django.db.models.expressions.RawSQL(..., request.$W, ...)
      - pattern: return django.db.models.expressions.RawSQL(..., request.$W, ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          django.db.models.expressions.RawSQL($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          django.db.models.expressions.RawSQL($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          django.db.models.expressions.RawSQL($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W

          ...

          django.db.models.expressions.RawSQL($STR % (..., $DATA, ...), ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL($INTERM, ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL($INTERM, ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL($INTERM, ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          django.db.models.expressions.RawSQL($INTERM, ...)

          '
    severity: WARNING
- rules:
  - id: sql-injection-using-extra-where
    languages:
    - python
    message: User-controlled data from a request is passed to 'extra()'. This could
      lead to a SQL injection and therefore protected information could be leaked.
      Instead, use parameterized queries or escape the user-controlled data by using
      `params` and not using quote placeholders in the SQL string.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: MEDIUM
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/expressions/#.objects.extra
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-inside: "def $FUNC(...):\n  ...\n"
    - pattern-either:
      - pattern: $MODEL.objects.extra(..., where=[..., $S.format(..., request.$W.get(...),
          ...), ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S % request.$W.get(...), ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., f"...{request.$W.get(...)}...",
          ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., request.$W.get(...), ...],
          ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR.format(..., $DATA, ...), ...],
          ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR % $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., f"...{$DATA}...", ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR + $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: $A = $MODEL.objects.extra(..., where=[..., request.$W.get(...), ...],
          ...)
      - pattern: return $MODEL.objects.extra(..., where=[..., request.$W.get(...),
          ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S.format(..., request.$W(...),
          ...), ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S % request.$W(...), ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., f"...{request.$W(...)}...",
          ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., request.$W(...), ...], ...)
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR.format(..., $DATA, ...), ...],
          ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR % $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., f"...{$DATA}...", ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR + $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: $A = $MODEL.objects.extra(..., where=[..., request.$W(...), ...],
          ...)
      - pattern: return $MODEL.objects.extra(..., where=[..., request.$W(...), ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S.format(..., request.$W[...],
          ...), ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S % request.$W[...], ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., f"...{request.$W[...]}...",
          ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., request.$W[...], ...], ...)
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., $STR.format(..., $DATA, ...), ...],
          ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., $STR % $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., f"...{$DATA}...", ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., $STR + $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: $A = $MODEL.objects.extra(..., where=[..., request.$W[...], ...],
          ...)
      - pattern: return $MODEL.objects.extra(..., where=[..., request.$W[...], ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S.format(..., request.$W,
          ...), ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., $S % request.$W, ...], ...)
      - pattern: $MODEL.objects.extra(..., where=[..., f"...{request.$W}...", ...],
          ...)
      - pattern: $MODEL.objects.extra(..., where=[..., request.$W, ...], ...)
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., $STR.format(..., $DATA, ...), ...],
          ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR.format(..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., $STR % $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., f"...{$DATA}...", ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = f"...{$DATA}..."

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., $STR + $DATA, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR + $DATA

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: $A = $MODEL.objects.extra(..., where=[..., request.$W, ...], ...)
      - pattern: return $MODEL.objects.extra(..., where=[..., request.$W, ...], ...)
      - pattern: '$DATA = request.$W.get(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR % (..., $DATA, ...), ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $MODEL.objects.extra(..., where=[..., $STR % (..., $DATA, ...), ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $MODEL.objects.extra(..., where=[..., $STR % (..., $DATA, ...), ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $MODEL.objects.extra(..., where=[..., $STR % (..., $DATA, ...), ...], ...)

          '
      - pattern: '$DATA = request.$W.get(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W(...)

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W[...]

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
      - pattern: '$DATA = request.$W

          ...

          $INTERM = $STR % (..., $DATA, ...)

          ...

          $MODEL.objects.extra(..., where=[..., $INTERM, ...], ...)

          '
    severity: WARNING
- rules:
  - fix: 'None

      '
    id: use-none-for-password-default
    languages:
    - python
    message: '''$VAR'' is using the empty string as its default and is being used
      to set the password on ''$MODEL''. If you meant to set an unusable password,
      set the default value to ''None'' or call ''set_unusable_password()''.'
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-521: Weak Password Requirements'
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A07:2021 - Identification and Authentication Failures
      references:
      - https://docs.djangoproject.com/en/3.0/ref/contrib/auth/#django.contrib.auth.models.User.set_password
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: '$VAR = request.$W.get($X, $EMPTY)

          ...

          $MODEL.set_password($VAR)

          ...

          $MODEL.save(...)

          '
      - pattern: "def $F(..., $VAR=$EMPTY, ...):\n  ...\n  $MODEL.set_password($VAR)\n"
    - metavariable-pattern:
        metavariable: $EMPTY
        pattern: '""'
    - focus-metavariable: $EMPTY
    severity: ERROR
- rules:
  - id: password-empty-string
    languages:
    - python
    message: '''$VAR'' is the empty string and is being used to set the password on
      ''$MODEL''. If you meant to set an unusable password, set the password to None
      or call ''set_unusable_password()''.'
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-521: Weak Password Requirements'
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2021 - Identification and Authentication Failures
      references:
      - https://docs.djangoproject.com/en/3.0/ref/contrib/auth/#django.contrib.auth.models.User.set_password
      subcategory:
      - vuln
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: '$MODEL.set_password($EMPTY)

          ...

          $MODEL.save()

          '
      - pattern: '$VAR = $EMPTY

          ...

          $MODEL.set_password($VAR)

          ...

          $MODEL.save()

          '
    - metavariable-regex:
        metavariable: $EMPTY
        regex: (\'\'|\"\")
    severity: ERROR
- rules:
  - id: avoid-mark-safe
    languages:
    - python
    message: '''mark_safe()'' is used to mark a string as "safe" for HTML output.
      This disables escaping and could therefore subject the content to XSS attacks.
      Use ''django.utils.html.format_html()'' to build HTML for rendering instead.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/utils/#django.utils.safestring.mark_safe
      - https://docs.djangoproject.com/en/3.0/ref/utils/#django.utils.html.format_html
      source-rule-url: https://bandit.readthedocs.io/en/latest/plugins/b703_django_mark_safe.html
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-not-inside: django.utils.html.format_html(...)
    - pattern-not: django.utils.safestring.mark_safe("...")
    - pattern: django.utils.safestring.mark_safe(...)
    severity: WARNING
- rules:
  - id: avoid-raw-sql
    languages:
    - python
    message: 'Detected the use of ''RawSQL'' or ''raw'' indicating the execution of
      a non-parameterized SQL query. This could lead to a SQL injection and therefore
      protected information could be leaked. Instead, use Django ORM and parameterized
      queries before raw SQL. An example of using the Django ORM is: `People.objects.get(name=''Bob'')`'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: LOW
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/expressions/#raw-sql-expressions
      - https://semgrep.dev/blog/2020/preventing-sql-injection-a-django-authors-perspective/
      source-rule-url: https://bandit.readthedocs.io/en/latest/plugins/b611_django_rawsql_used.html
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: $MODEL.objects.raw($QUERY, ...)
      - pattern: django.db.models.expressions.RawSQL(...)
    - pattern-not: $MODEL.objects.raw("...")
    - pattern-not: django.db.models.expressions.RawSQL("...")
    severity: WARNING
- rules:
  - fix: "if django.contrib.auth.password_validation.validate_password($X, user=$MODEL):\n\
      \    $MODEL.set_password($X)\n"
    id: unvalidated-password
    languages:
    - python
    message: The password on '$MODEL' is being set without validating the password.
      Call django.contrib.auth.password_validation.validate_password() with validation
      functions before setting the password. See https://docs.djangoproject.com/en/3.0/topics/auth/passwords/
      for more information.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-521: Weak Password Requirements'
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2021 - Identification and Authentication Failures
      references:
      - https://docs.djangoproject.com/en/3.0/topics/auth/passwords/#module-django.contrib.auth.password_validation
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-not-inside: "if <... django.contrib.auth.password_validation.validate_password(...)\
        \ ...>:\n    ...\n"
    - pattern-not-inside: 'django.contrib.auth.password_validation.validate_password(...)

        ...

        '
    - pattern-not-inside: "try:\n  ...\n  django.contrib.auth.password_validation.validate_password(...)\n\
        \  ...\nexcept $EX:\n  ...\n...\n"
    - pattern-not-inside: "try:\n  ...\n  django.contrib.auth.password_validation.validate_password(...)\n\
        \  ...\nexcept $EX as $E:\n  ...\n...\n"
    - pattern-not: UserModel().set_password($X)
    - pattern: $MODEL.set_password($X)
    severity: WARNING
- rules:
  - id: custom-expression-as-sql
    languages:
    - python
    message: Detected a Custom Expression ''$EXPRESSION'' calling ''as_sql(...).''
      This could lead to SQL injection, which can result in attackers exfiltrating
      sensitive data. Instead, ensure no user input enters this function or that user
      input is properly sanitized.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: LOW
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/expressions/#django.db.models.Func.as_sql
      - https://semgrep.dev/blog/2020/preventing-sql-injection-a-django-authors-perspective/
      subcategory:
      - audit
      technology:
      - django
    pattern: $EXPRESSION.as_sql(...)
    severity: WARNING
- rules:
  - id: django-secure-set-cookie
    languages:
    - python
    message: Django cookies should be handled securely by setting secure=True, httponly=True,
      and samesite='Lax' in response.set_cookie(...). If your situation calls for
      different settings, explicitly disable the setting. If you want to send the
      cookie over http, set secure=False. If you want to let client-side JavaScript
      read the cookie, set httponly=False. If you want to attach cookies to requests
      for external sites, set samesite=None.
    metadata:
      asvs:
        control_id: 3.4 Missing Cookie Attributes
        control_url: https://github.com/OWASP/ASVS/blob/master/4.0/en/0x12-V3-Session-management.md#v34-cookie-based-session-management
        section: 'V3: Session Management Verification Requirements'
        version: '4'
      category: security
      confidence: LOW
      cwe:
      - 'CWE-614: Sensitive Cookie in HTTPS Session Without ''Secure'' Attribute'
      impact: LOW
      likelihood: LOW
      owasp:
      - A05:2021 - Security Misconfiguration
      references:
      - https://docs.djangoproject.com/en/3.0/ref/request-response/#django.http.HttpResponse.set_cookie
      - https://semgrep.dev/blog/2020/bento-check-keeping-cookies-safe-in-flask/
      - https://bento.dev/checks/flask/secure-set-cookie/
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern-inside: 'import django.http.HttpResponse

          ...

          '
      - pattern-inside: 'import django.shortcuts.render

          ...

          '
    - pattern-not-inside: "LANGUAGE_QUERY_PARAMETER = 'language'\n...\ndef set_language(request):\n\
        \    ...\n# Exclude vendored contrib/messages/storage/cookie.py\n"
    - pattern-not-inside: "class CookieStorage(django.contrib.messages.storage.base.BaseStorage):\n\
        \    ...\n# Exclude cookies handled by vendored middleware\n"
    - pattern-not: response.set_cookie(django.conf.settings.SESSION_COOKIE_NAME, ...)
    - pattern-not: response.set_cookie(django.conf.settings.CSRF_COOKIE_NAME, ...)
    - pattern-not: response.set_cookie(django.conf.settings.LANGUAGE_COOKIE_NAME,
        ...)
    - pattern-not: response.set_cookie(rest_framework_jwt.settings.api_settings.JWT_AUTH_COOKIE,
        ...)
    - pattern-not: response.set_cookie(..., secure=$A, httponly=$B, samesite=$C, ...)
    - pattern-not: response.set_cookie(..., **$A)
    - pattern: response.set_cookie(...)
    severity: WARNING
- rules:
  - id: no-csrf-exempt
    languages:
    - python
    message: Detected usage of @csrf_exempt, which indicates that there is no CSRF
      token set for this route. This could lead to an attacker manipulating the user's
      account and exfiltration of private data. Instead, create a function without
      this decorator.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-352: Cross-Site Request Forgery (CSRF)'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A01:2021 - Broken Access Control
      references:
      - https://owasp.org/Top10/A01_2021-Broken_Access_Control
      subcategory:
      - vuln
      technology:
      - django
    pattern: "@django.views.decorators.csrf.csrf_exempt\ndef $R(...):\n  ...\n"
    severity: WARNING
- rules:
  - id: avoid-insecure-deserialization
    languages:
    - python
    message: Avoid using insecure deserialization library, backed by `pickle`, `_pickle`,
      `cpickle`, `dill`, `shelve`, or `yaml`, which are known to lead to remote code
      execution vulnerabilities.
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
      - 'CWE-502: Deserialization of Untrusted Data'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: MEDIUM
      owasp:
      - A08:2017 - Insecure Deserialization
      - A08:2021 - Software and Data Integrity Failures
      references:
      - https://docs.python.org/3/library/pickle.html
      subcategory:
      - vuln
      technology:
      - django
    mode: taint
    pattern-sinks:
    - pattern-either:
      - patterns:
        - pattern-either:
          - pattern: 'pickle.$PICKLEFUNC(...)

              '
          - pattern: '_pickle.$PICKLEFUNC(...)

              '
          - pattern: 'cPickle.$PICKLEFUNC(...)

              '
          - pattern: 'shelve.$PICKLEFUNC(...)

              '
        - metavariable-regex:
            metavariable: $PICKLEFUNC
            regex: dumps|dump|load|loads
      - patterns:
        - pattern: dill.$DILLFUNC(...)
        - metavariable-regex:
            metavariable: $DILLFUNC
            regex: dump|dump_session|dumps|load|load_session|loads
      - patterns:
        - pattern: yaml.$YAMLFUNC(...)
        - pattern-not: yaml.$YAMLFUNC(..., Dumper=SafeDumper, ...)
        - pattern-not: yaml.$YAMLFUNC(..., Dumper=yaml.SafeDumper, ...)
        - pattern-not: yaml.$YAMLFUNC(..., Loader=SafeLoader, ...)
        - pattern-not: yaml.$YAMLFUNC(..., Loader=yaml.SafeLoader, ...)
        - metavariable-regex:
            metavariable: $YAMLFUNC
            regex: dump|dump_all|load|load_all
    pattern-sources:
    - pattern-either:
      - patterns:
        - pattern-inside: "def $INSIDE(..., $PARAM, ...):\n  ...\n"
        - pattern-either:
          - pattern: request.$REQFUNC(...)
          - pattern: request.$REQFUNC.get(...)
          - pattern: request.$REQFUNC[...]
    severity: ERROR
- rules:
  - id: extends-custom-expression
    languages:
    - python
    message: 'Found extension of custom expression: $CLASS. Extending expressions
      in this way could inadvertently lead to a SQL injection vulnerability, which
      can result in attackers exfiltrating sensitive data. Instead, ensure no user
      input enters this function or that user input is properly sanitized.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: LOW
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/expressions/#avoiding-sql-injection
      - https://semgrep.dev/blog/2020/preventing-sql-injection-a-django-authors-perspective/
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: "class $CLASS(..., django.db.models.Func, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Func, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Expression, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Expression, ...):\n\
        \    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Value, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Value, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.DurationValue, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.DurationValue, ...):\n\
        \    ...\n"
    - pattern: "class $CLASS(..., django.db.models.RawSQL, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.RawSQL, ...):\n   \
        \ ...\n"
    - pattern: "class $CLASS(..., django.db.models.Star, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Star, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Random, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Random, ...):\n   \
        \ ...\n"
    - pattern: "class $CLASS(..., django.db.models.Col, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Col, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Ref, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Ref, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.ExpressionList, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.ExpressionList, ...):\n\
        \    ...\n"
    - pattern: "class $CLASS(..., django.db.models.ExpressionWrapper, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.ExpressionWrapper,\
        \ ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.When, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.When, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Case, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Case, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.Subquery, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Subquery, ...):\n \
        \   ...\n"
    - pattern: "class $CLASS(..., django.db.models.Exists, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Exists, ...):\n   \
        \ ...\n"
    - pattern: "class $CLASS(..., django.db.models.Window, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.Window, ...):\n   \
        \ ...\n"
    - pattern: "class $CLASS(..., django.db.models.WindowFrame, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.WindowFrame, ...):\n\
        \    ...\n"
    - pattern: "class $CLASS(..., django.db.models.RowRange, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.RowRange, ...):\n \
        \   ...\n"
    - pattern: "class $CLASS(..., django.db.models.ValueRange, ...):\n    ...\n"
    - pattern: "class $CLASS(..., django.db.models.expressions.ValueRange, ...):\n\
        \    ...\n"
    severity: WARNING
- rules:
  - id: avoid-query-set-extra
    languages:
    - python
    message: QuerySet.extra' does not provide safeguards against SQL injection and
      requires very careful use. SQL injection can lead to critical data being stolen
      by attackers. Instead of using '.extra', use the Django ORM and parameterized
      queries such as `People.objects.get(name='Bob')`.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
        (''SQL Injection'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: HIGH
      likelihood: LOW
      owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/models/querysets/#django.db.models.query.QuerySet.extra
      - https://semgrep.dev/blog/2020/preventing-sql-injection-a-django-authors-perspective/
      source-rule-url: https://bandit.readthedocs.io/en/latest/plugins/b610_django_extra_used.html
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern: $MODEL.extra(...)
    - pattern-not-inside: '$MODEL.extra(select = {$KEY: "..."})'
    severity: WARNING
- rules:
  - id: missing-throttle-config
    languages:
    - python
    message: Django REST framework configuration is missing default rate- limiting
      options. This could inadvertently allow resource starvation or Denial of Service
      (DoS) attacks. Add 'DEFAULT_THROTTLE_CLASSES' and 'DEFAULT_THROTTLE_RATES' to
      add rate-limiting to your application.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-400: Uncontrolled Resource Consumption'
      cwe2022-top25: true
      impact: HIGH
      likelihood: LOW
      owasp:
      - A05:2021 - Security Misconfiguration
      - A06:2017 - Security Misconfiguration
      references:
      - https://www.django-rest-framework.org/api-guide/throttling/#setting-the-throttling-policy
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-not-inside: "REST_FRAMEWORK = {\n  ...,\n  \"DEFAULT_THROTTLE_RATES\"\
        : ...\n}\n"
    - pattern-inside: 'REST_FRAMEWORK = ...

        '
    - pattern: REST_FRAMEWORK
    severity: WARNING
- rules:
  - id: template-blocktranslate-no-escape
    languages:
    - generic
    message: Translated strings will not be escaped when rendered in a template. This
      leads to a vulnerability where translators could include malicious script tags
      in their translations. Consider using `force_escape` to explicitly escape a
      translated text.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://edx.readthedocs.io/projects/edx-developer-guide/en/latest/preventing_xss/preventing_xss_in_django_templates.html#html-escaping-translations-in-django-templates
      - https://docs.djangoproject.com/en/3.1/topics/i18n/translation/#internationalization-in-template-code
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: '{% blocktranslate...%}

          '
      - pattern: '{% blocktrans...%}

          '
    - pattern-not-inside: '{%...filter...force_escape...%}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {%...endfilter...%}

        '
    severity: INFO
- rules:
  - id: class-extends-safestring
    languages:
    - python
    message: Found a class extending 'SafeString', 'SafeText' or 'SafeData'. These
      classes are for bypassing the escaping engine built in to Django and should
      not be used directly. Improper use of this class exposes your application to
      cross-site scripting (XSS) vulnerabilities. If you need this functionality,
      use 'mark_safe' instead and ensure no user data can reach it.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/howto/custom-template-tags/#filters-and-auto-escaping
      - https://github.com/django/django/blob/f138e75910b1e541686c4dce3d8f467f6fc234cb/django/utils/safestring.py#L11
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: "class $CLASS(django.utils.safestring.SafeString):\n  ...\n"
    - pattern: "class $CLASS(django.utils.safestring.SafeText):\n  ...\n"
    - pattern: "class $CLASS(django.utils.safestring.SafeData):\n  ..."
    severity: WARNING
- rules:
  - id: direct-use-of-httpresponse
    languages:
    - python
    message: Detected data rendered directly to the end user via 'HttpResponse' or
      a similar object. This bypasses Django's built-in cross-site scripting (XSS)
      defenses and could result in an XSS vulnerability. Use Django's template engine
      to safely render HTML.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/intro/tutorial03/#a-shortcut-render
      - https://docs.djangoproject.com/en/3.1/topics/http/shortcuts/#render
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-not: django.http.$ANY("...", ...)
    - pattern-not: django.http.$ANY()
    - pattern-not: django.http.$ANY(..., content=None, ...)
    - pattern-not: django.http.$ANY(status=...)
    - pattern-not: django.http.HttpResponseNotAllowed([...])
    - pattern-either:
      - patterns:
        - pattern-either:
          - pattern: django.http.HttpResponse(...)
          - pattern: django.http.HttpResponseBadRequest(...)
          - pattern: django.http.HttpResponseNotFound(...)
          - pattern: django.http.HttpResponseForbidden(...)
          - pattern: django.http.HttpResponseNotAllowed(...)
          - pattern: django.http.HttpResponseGone(...)
          - pattern: django.http.HttpResponseServerError(...)
        - pattern-not: django.http.$ANY(...,content_type=$TYPE,...)
      - patterns:
        - pattern-either:
          - pattern: django.http.HttpResponse(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseBadRequest(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseNotFound(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseForbidden(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseNotAllowed(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseGone(...,content_type=$TYPE,...)
          - pattern: django.http.HttpResponseServerError(...,content_type=$TYPE,...)
        - metavariable-regex:
            metavariable: $TYPE
            regex: .*[tT][eE][xX][tT]/[hH][tT][mM][lL].*
    severity: WARNING
- rules:
  - id: html-safe
    languages:
    - python
    message: '`html_safe()` add the `__html__` magic method to the provided class.
      The `__html__` method indicates to the Django template engine that the value
      is ''safe'' for rendering. This means that normal HTML escaping will not be
      applied to the return value. This exposes your application to cross-site scripting
      (XSS) vulnerabilities. If you need to render raw HTML, consider instead using
      `mark_safe()` which more clearly marks the intent to render raw HTML than a
      class with a magic method.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/_modules/django/utils/html/#html_safe
      - https://gist.github.com/minusworld/7885d8a81dba3ea2d1e4b8fd3c218ef5
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: django.utils.html.html_safe(...)
    - pattern: "@django.utils.html.html_safe\nclass $CLASS(...):\n  ...\n"
    severity: WARNING
- rules:
  - id: formathtml-fstring-parameter
    languages:
    - python
    message: Passing a formatted string as first parameter to `format_html` disables
      the proper encoding of variables. Any HTML in the first parameter is not encoded.
      Using a formatted string as first parameter obscures which parameters are encoded.
      Correct use of `format_html` is passing a static format string as first parameter,
      and the variables to substitute as subsequent parameters.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.2/ref/utils/#django.utils.html.format_html
      subcategory:
      - audit
      technology:
      - django
    pattern-either:
    - pattern: format_html(<... f"..." ...>, ...)
    - pattern: format_html("..." % ..., ...)
    - pattern: format_html("...".format(...), ...)
    severity: WARNING
- rules:
  - id: html-magic-method
    languages:
    - python
    message: The `__html__` method indicates to the Django template engine that the
      value is 'safe' for rendering. This means that normal HTML escaping will not
      be applied to the return value. This exposes your application to cross-site
      scripting (XSS) vulnerabilities. If you need to render raw HTML, consider instead
      using `mark_safe()` which more clearly marks the intent to render raw HTML than
      a class with a magic method.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/_modules/django/utils/html/#conditional_escape
      - https://gist.github.com/minusworld/7885d8a81dba3ea2d1e4b8fd3c218ef5
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-inside: "class $CLASS(...):\n  ...\n"
    - pattern: "def __html__(...):\n  ...\n"
    severity: WARNING
- rules:
  - id: template-autoescape-off
    languages:
    - regex
    message: Detected a template block where autoescaping is explicitly disabled with
      '{% autoescape off %}'. This allows rendering of raw HTML in this segment. Turn
      autoescaping on to prevent cross-site scripting (XSS). If you must do this,
      consider instead, using `mark_safe` in Python code.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/ref/templates/builtins/#autoescape
      subcategory:
      - audit
      technology:
      - django
    paths:
      include:
      - '*.html'
    pattern-regex: '{%\s+autoescape\s+off\s+%}'
    severity: WARNING
- rules:
  - fix: 'True

      '
    id: context-autoescape-off
    languages:
    - python
    message: 'Detected a Context with autoescape disabled. If you are rendering any
      web pages, this exposes your application to cross-site scripting (XSS) vulnerabilities.
      Remove ''autoescape: False'' or set it to ''True''.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/ref/settings/#templates
      - https://docs.djangoproject.com/en/3.1/topics/templates/#django.template.backends.django.DjangoTemplates
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: '{..., "autoescape": $FALSE, ...}

          '
      - pattern: '$D["autoescape"] = $FALSE

          '
    - metavariable-pattern:
        metavariable: $FALSE
        pattern: 'False

          '
    - focus-metavariable: $FALSE
    severity: WARNING
- rules:
  - id: template-var-unescaped-with-safeseq
    languages:
    - regex
    message: Detected a template variable where autoescaping is explicitly disabled
      with '| safeseq' filter. This allows rendering of raw HTML in this segment.
      Ensure no user data is rendered here, otherwise this is a cross-site scripting
      (XSS) vulnerability. If you must do this, use `mark_safe` in your Python code.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.0/ref/templates/builtins/#safeseq
      subcategory:
      - audit
      technology:
      - django
    paths:
      include:
      - '*.html'
    pattern-regex: '{{.*?\|\s+safeseq(\s+}})?'
    severity: WARNING
- rules:
  - id: template-translate-as-no-escape
    languages:
    - generic
    message: Translated strings will not be escaped when rendered in a template. This
      leads to a vulnerability where translators could include malicious script tags
      in their translations. Consider using `force_escape` to explicitly escape a
      translated text.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://edx.readthedocs.io/projects/edx-developer-guide/en/latest/preventing_xss/preventing_xss_in_django_templates.html#html-escaping-translations-in-django-templates
      - https://docs.djangoproject.com/en/3.1/topics/i18n/translation/#internationalization-in-template-code
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern-either:
      - pattern: '{% translate ... as $TRANS ... %}

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          {{ ... $TRANS ... }}

          '
      - pattern: '{% trans ... as $TRANS ... %}

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          ...

          {{ ... $TRANS ... }}

          '
    - pattern-not: '{% translate ... as $TRANS ... %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {{ ... $TRANS ... | ... force_escape ... }}

        '
    - pattern-not: '{% trans ... as $TRANS ... %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {{ ... $TRANS ... | ... force_escape ... }}

        '
    - pattern-not: '{% translate ... as $TRANS ... %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {% filter force_escape %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {{ ... $TRANS ... }}

        '
    - pattern-not: '{% trans ... as $TRANS ... %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {% filter force_escape %}

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        ...

        {{ ... $TRANS ... }}

        '
    severity: INFO
- rules:
  - id: filter-with-is-safe
    languages:
    - python
    message: Detected Django filters flagged with 'is_safe'. 'is_safe' tells Django
      not to apply escaping on the value returned by this filter (although the input
      is escaped). Used improperly, 'is_safe' could expose your application to cross-site
      scripting (XSS) vulnerabilities. Ensure this filter does not 1) add HTML characters,
      2) remove characters, or 3) use external data in any way. Consider instead removing
      'is_safe' and explicitly marking safe content with 'mark_safe()'.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/topics/security/#cross-site-scripting-xss-protection
      - https://docs.djangoproject.com/en/3.1/howto/custom-template-tags/#filters-and-auto-escaping
      - https://stackoverflow.com/questions/7665512/why-use-is-safe
      subcategory:
      - audit
      technology:
      - django
    pattern: "@register.filter(..., is_safe=True, ...)\ndef $FILTER(...):\n  ..."
    severity: WARNING
- rules:
  - fix: 'True

      '
    id: global-autoescape-off
    languages:
    - python
    message: 'Autoescape is globally disbaled for this Django application. If you
      are rendering any web pages, this exposes your application to cross-site scripting
      (XSS) vulnerabilities. Remove ''autoescape: False'' or set it to ''True''.'
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
        Scripting'')'
      cwe2021-top25: true
      cwe2022-top25: true
      impact: MEDIUM
      likelihood: LOW
      owasp:
      - A07:2017 - Cross-Site Scripting (XSS)
      - A03:2021 - Injection
      references:
      - https://docs.djangoproject.com/en/3.1/ref/settings/#templates
      - https://docs.djangoproject.com/en/3.1/topics/templates/#django.template.backends.django.DjangoTemplates
      subcategory:
      - audit
      technology:
      - django
    patterns:
    - pattern: '{..., ''BACKEND'': ..., ''OPTIONS'': {..., ''autoescape'': $FALSE,
        ...}, ...}

        '
    - metavariable-pattern:
        metavariable: $FALSE
        pattern: 'False

          '
    - focus-metavariable: $FALSE
    severity: WARNING
- rules:
  - id: debug-template-tag
    languages:
    - regex
    message: Detected a debug template tag in a Django template. This dumps debugging
      information to the page when debug mode is enabled. Showing debug information
      to users is dangerous because it may reveal information about your environment
      that malicious actors can use to gain access to the system. Remove the debug
      tag.
    metadata:
      category: security
      confidence: LOW
      cwe:
      - 'CWE-489: Active Debug Code'
      impact: MEDIUM
      likelihood: LOW
      owasp: A06:2017 - Security Misconfiguration
      references:
      - https://docs.djangoproject.com/en/4.2/ref/templates/builtins/#debug
      - https://stackoverflow.com/questions/2213977/django-debug-display-all-variables-of-a-page
      subcategory:
      - audit
      technology:
      - django
    paths:
      include:
      - '*.html'
    pattern-regex: ({% debug %})
    severity: WARNING
